<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Beer Mini‚ÄëApp | Router + BackButton + No‚ÄëSwipe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --tabH: 64px;
      --navGap: 12px;
      --bg:#0b0c15; --text:#f4f6fa; --border:rgba(255,255,255,.10);
      --amber:#f9b24d; --green:#37d67a; --red:#ff6b6b; --blue:#3d7eff;
      --appW: 428px;
      --wrapPadX: 14px;
      --wrapPadTop: 16px;
    }
    *{ box-sizing:border-box }
    img{ max-width:100%; display:block }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.45 Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      overscroll-behavior: none;
    }
    @media (min-width:900px){ body{ display:grid; place-items:center; } }
    .wrap{
      width:100%; max-width:1080px; margin:0 auto;
      min-height:100svh;
      padding:16px 14px calc(var(--tabH) + var(--navGap) + env(safe-area-inset-bottom,0px) + 22px);
    }
    @media (min-width:900px){
      .wrap{ max-width:var(--appW); padding:20px 14px calc(var(--tabH) + var(--navGap) + env(safe-area-inset-bottom,0px) + 22px); }
    }
    main>section, section.page{ display:none }
    main>section.active, section.page.active{ display:block }

    /* bottom nav */
    .btm-nav{
      position:fixed; left:0; right:0;
      bottom: calc(var(--navGap) + env(safe-area-inset-bottom, 0px));
      height: var(--tabH);
      z-index: 9999;
      display:grid; grid-template-columns:repeat(5,1fr); align-items:center;
      padding: 6px 6px 6px;
      background: rgba(10,12,14,.72);
      -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.08);
      border-left:0; border-right:0; border-bottom:0;
      border-radius: 16px 16px 0 0;
    }
    .btm-nav .tab{
      height:100%; border:0; background:none; color:#dfe3e6; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      font-size:11px; font-weight:700;
      filter: grayscale(.35) saturate(.8); opacity:.85;
      border-radius:14px; -webkit-tap-highlight-color:transparent;
    }
    .btm-nav .tab img{ width:24px; height:24px }
    .btm-nav .tab:active{ transform: translateY(1px) }
    .btm-nav .tab.active{ opacity:1; filter:none; color:#fff; position:relative }
    .btm-nav .tab.active::before{
      content:""; position:absolute; inset:6px 10px 18px 10px; z-index:-1;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:12px;
    }
    @media (min-width:900px){
      .btm-nav{ left:50%; right:auto; width: var(--appW); transform: translateX(-50%); }
    }

    /* cards */
    .card{ background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:16px; padding:16px; }
    .page-title{ margin:0 0 12px }
    .h1{ font-weight:800; font-size:20px; margin:0 0 8px }
    .muted-sm{ opacity:.8 }

    /* sheet */
    .sheet{ position:fixed; inset:0; z-index:9990; pointer-events:none; }
    .sheet.is-open{ pointer-events:auto; }
    .sheet__overlay{
      position:absolute; left:0; right:0; top:0;
      bottom: calc(var(--tabH) + var(--navGap) + env(safe-area-inset-bottom, 0px));
      background: rgba(0,0,0,.48); opacity:0; transition:opacity .2s ease;
      -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px);
    }
    .sheet.is-open .sheet__overlay{ opacity:1; }
    .sheet__panel{
      position:absolute; left:0; right:0; margin:0 auto;
      width:min(820px,100%); max-height:88vh; overflow:auto;
      background:linear-gradient(180deg, rgba(18,20,24,.98), rgba(18,20,24,.96));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 20px 40px rgba(0,0,0,.45);
      transition: transform .28s cubic-bezier(.2,.8,.2,1), opacity .2s ease;
      padding:12px 14px calc(16px + var(--tabH) + var(--navGap) + env(safe-area-inset-bottom, 0px));
      will-change: transform;
      touch-action: pan-y;
    }
    .sheet.sheet-bottom .sheet__panel{ bottom:0; top:auto; border-radius: 16px 16px 0 0; transform: translateY(100%); }
    .sheet.is-open.sheet-bottom .sheet__panel{ transform: translateY(0); }
    .sheet__handle{ width:42px; height:4px; border-radius:999px; margin:6px auto 10px; background:rgba(255,255,255,.18) }
    .sheet__header{ display:flex; align-items:center; gap:10px; margin:0 0 8px }
    .sheet__title{ font-weight:800; font-size:18px; margin:0 }
    .sheet__close{ margin-left:auto; border:0; background:transparent; color:#fff; opacity:.85; width:36px; height:36px; border-radius:10px; display:grid; place-items:center }
    .sheet__close:active{ transform:translateY(1px); opacity:1 }
    .sheet__body{ display:grid; gap:10px }
    body.sheet-open{ overflow:hidden }
    @media (min-width:900px){ .sheet__panel{ width:min(var(--appW),92vw); } }

    /* HERO */
    .hero{ position: relative; margin: calc(-1 * var(--wrapPadTop)) calc(-1 * var(--wrapPadX)) 14px; padding-top: env(safe-area-inset-top, 0px); background:#000; overflow:hidden; }
    .hero__media{ width:100%; height: clamp(260px, 42vh, 460px); object-fit: cover; display:block; }
    .hero::after{ content:""; position:absolute; left:0; right:0; bottom:-1px; height:84px; pointer-events:none; background:linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--bg) 100%); }
    @media (min-width:900px){ .hero{ margin-left: calc((var(--appW) - 100vw)/2 - var(--wrapPadX)); margin-right: calc((var(--appW) - 100vw)/2 - var(--wrapPadX)); } }

    /* Promo */
    .promo{ display:grid; grid-template-columns:48px 1fr auto; align-items:center; gap:12px; padding:10px 12px; margin:0 0 12px; background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:16px; }
    .promo__icon{ width:48px; height:48px; border-radius:12px; display:grid; place-items:center; background:rgba(255,255,255,.06); overflow:hidden }
    .promo__icon img{ width:28px; height:28px; display:block }
    .promo__title{ font-weight:800 }
    .promo__sub{ opacity:.8; font-size:13px; margin-top:2px }
    .promo__btn{ height:36px; padding:0 14px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:linear-gradient(180deg,#f9b24d,#f29117); color:#16181e; font-weight:900; cursor:pointer; }
    .promo__btn:active{ transform: translateY(1px) }

    /* List */
    .list-card .list-head{ font:800 16px/1.2 Inter,system-ui; margin-bottom:8px }
    .list{ display:grid; gap:8px }
    .list-card .list__item{ background:transparent; border:0; box-shadow:none }
    .list-card.tight .list{ margin-left:-16px; margin-right:-16px }
    .list-card.tight .list__item{ padding:12px 16px; gap:10px; display:grid; grid-template-columns:36px 1fr auto; align-items:center; }
    .list-card.tight .list__icon{ width:36px; height:36px; border-radius:10px; display:grid; place-items:center; background:rgba(255,255,255,.06); overflow:hidden }
    .list-card.tight .list__icon img{ width:22px; height:22px; display:block }
    .list__text{ display:grid; gap:4px }
    .list__title{ font-weight:800 }
    .list__sub{ opacity:.8; font-size:13px }
    .list__chev-btn{ width:36px; height:36px; display:grid; place-items:center; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:transparent; color:inherit; font-size:18px; cursor:pointer; }
    .list__chev-btn:active{ transform:translateY(1px) }
    .list-card .list__item:hover{ background: rgba(255,255,255,.04) }

    /* badges, meters */
    .badge{ display:inline-grid; place-items:center; padding:3px 8px; border-radius:999px; font:700 12px/1 Inter; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); }
    .badge--amber{ background:rgba(249,178,77,.15); border-color:rgba(249,178,77,.35); color:#ffd59c }
    .badge--green{ background:rgba(55,214,122,.15); border-color:rgba(55,214,122,.35); color:#bff5d6 }
    .meter{ height:8px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden }
    .meter>i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#f9b24d,#f29117); }

    /* buttons */
    .btn{ height:40px; padding:0 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:#fff; font-weight:800; cursor:pointer }
    .btn:active{ transform: translateY(1px) }
    .btn-primary{ background:linear-gradient(180deg,#f9b24d,#f29117); color:#16181e; border:0 }

    /* grid small */
    .g{ display:grid; gap:10px }
    .g2{ grid-template-columns:1fr 1fr }
    .g3{ grid-template-columns:1fr 1fr 1fr }
    @media (max-width:420px){ .g2,.g3{ grid-template-columns:1fr } }

    /* Cap Toss area ‚Äì reliable pointer input */
    #cap-area{ touch-action:none; user-select:none; -webkit-user-select:none; position:relative; margin-top:10px; height:260px; border:1px dashed rgba(255,255,255,.18); border-radius:12px; overflow:hidden; background:radial-gradient(120% 120% at 50% 100%, rgba(249,178,77,.12), rgba(255,255,255,.02)); }
    #cap-area canvas{ position:absolute; inset:0; width:100%; height:100%; display:block }
    #cap-area .cap-msg{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); opacity:.8; font-size:14px; text-align:center }

    /* confetti canvas */
    #confetti{ position:fixed; inset:0; pointer-events:none; z-index:99999; }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="wrap">
    <nav id="btm-nav" class="btm-nav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <button class="tab" data-page="home"><img src="ic_home.png" alt=""><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
      <button class="tab" data-page="menu"><img src="ic_services.png" alt=""><span>–ú–µ–Ω—é</span></button>
      <button class="tab" data-page="games"><img src="ic_consult.png" alt=""><span>–ò–≥—Ä—ã</span></button>
      <button class="tab" data-page="bonuses"><img src="ic_bonus.png" alt=""><span>–ë–æ–Ω—É—Å—ã</span></button>
      <button class="tab" data-page="profile"><img src="ic_about.png" alt=""><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    </nav>

    <main>
      <!-- Bottom Sheet -->
      <div id="sheet" class="sheet sheet-bottom" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="sheet__overlay" data-close-sheet></div>
        <section class="sheet__panel" tabindex="-1">
          <div class="sheet__handle"></div>
          <header class="sheet__header">
            <h3 class="sheet__title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
            <button class="sheet__close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" data-close-sheet>‚úï</button>
          </header>
          <div class="sheet__body" id="sheet-body"></div>
        </section>
      </div>

      <!-- ===== Templates for sheets ===== -->
      <template id="tpl-cap-toss">
        <div class="card">
          <div class="h1">Cap Toss ‚Äî –±—Ä–æ—Å—å –∫—Ä—ã—à–∫—É!</div>
          <p class="muted-sm">–ó–∞ 30 —Å–µ–∫—É–Ω–¥ –Ω–∞–∫–∏–¥–∞–π –æ—á–∫–æ–≤. –ü–æ–ø–∞–¥–∞–Ω–∏—è ‚Üí –∫–æ–∏–Ω—ã. –ê–Ω—Ç–∏—á–∏—Ç, –≤–∏–±—Ä–æ, –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ ‚Äî –≤—Å—ë –∫–∞–∫ –ª—é–±–∏–º.</p>
          <div class="g g2">
            <button class="btn btn-primary" data-action="start-cap">–°—Ç–∞—Ä—Ç (30 —Å–µ–∫)</button>
            <button class="btn" data-action="cap-help">–ü—Ä–∞–≤–∏–ª–∞</button>
          </div>
          <div id="cap-area">
            <canvas id="cap-canvas"></canvas>
            <div class="cap-msg">–°–≤–∞–π–ø–Ω–∏/—Ç–∞–ø–Ω–∏, —á—Ç–æ–±—ã –±—Ä–æ—Å–∏—Ç—å –∫—Ä—ã—à–∫—É</div>
          </div>
          <div class="g g3" style="margin-top:10px">
            <div class="card" style="text-align:center">
              <div class="muted-sm">–û—á–∫–∏</div>
              <div id="cap-score" class="h1">0</div>
            </div>
            <div class="card" style="text-align:center">
              <div class="muted-sm">–ë—Ä–æ—Å–∫–∏</div>
              <div id="cap-shots" class="h1">0/15</div>
            </div>
            <div class="card" style="text-align:center">
              <div class="muted-sm">–í—Ä–µ–º—è</div>
              <div id="cap-time" class="h1">00:30</div>
            </div>
          </div>
        </div>
      </template>

      <template id="tpl-passport">
        <div class="card">
          <div class="h1">–ü–∏–≤–Ω–æ–π –ü–∞—Å–ø–æ—Ä—Ç —Å—Ç–∏–ª–µ–π</div>
          <p class="muted-sm">–°–æ–±–µ—Ä–∏ 6 —à—Ç–∞–º–ø–æ–≤ (Lager, IPA, Stout, Weizen, Sour, Cider) ‚Äî –ø—Ä–∏–∑.</p>
          <div class="g g3" id="passport-grid"></div>
          <div class="g g2" style="margin-top:8px">
            <button class="btn" data-action="add-stamp">–î–æ–±–∞–≤–∏—Ç—å —à—Ç–∞–º–ø</button>
            <button class="btn" data-action="reset-passport">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </template>

      <template id="tpl-spin">
        <div class="card">
          <div class="h1">–ö–æ–ª–µ—Å–æ –ü–∏–≤–∞ ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–ø–∏–Ω</div>
          <div id="spin-state" class="muted-sm">–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω‚Ä¶</div>
          <div class="g" style="margin-top:8px">
            <button class="btn btn-primary" data-action="spin">–ö—Ä—É—Ç–∏—Ç—å</button>
            <div class="meter"><i id="coin-meter"></i></div>
            <div><span class="badge badge--amber">–ö–æ–∏–Ω—ã: <b id="coins">0</b></span></div>
          </div>
          <div id="spin-log" class="muted-sm" style="margin-top:8px"></div>
        </div>
      </template>

      <template id="tpl-trivia">
        <div class="card">
          <div class="h1">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ ¬´–£–≥–∞–¥–∞–π —Å—Ç–∏–ª—å¬ª</div>
          <form id="trivia-form" class="g">
            <!-- –≤–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã JS -->
          </form>
          <div class="g g2" style="margin-top:8px">
            <button class="btn btn-primary" data-action="submit-trivia">–°–¥–∞—Ç—å</button>
            <button class="btn" data-action="reset-trivia">–°–±—Ä–æ—Å</button>
          </div>
          <div id="trivia-result" class="muted-sm" style="margin-top:8px"></div>
        </div>
      </template>

      <template id="tpl-ref">
        <div class="card">
          <div class="h1">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π</div>
          <p class="muted-sm">–ó–∞ –¥—Ä—É–≥–∞ ‚Äî +100 –∫–æ–∏–Ω–æ–≤. –ó–∞ 3 –¥—Ä—É–∑–µ–π ‚Äî –º–∏–Ω–∏‚Äë–¥–µ–≥—É—Å—Ç–∞—Ü–∏—è.</p>
          <div class="g">
            <input id="ref-link" class="btn" readonly value="" />
            <div class="g g2">
              <button class="btn btn-primary" data-action="copy-ref">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn" data-action="share-ref">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            </div>
          </div>
        </div>
      </template>

      <template id="tpl-receipt">
        <div class="card">
          <div class="h1">–î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑–∏—Ç (—Å–µ—Ä–∏—è 3 –∑–∞ 30)</div>
          <div class="g g2">
            <input id="rcp-amount" class="btn" inputmode="decimal" placeholder="–°—É–º–º–∞ —á–µ–∫–∞" />
            <button class="btn btn-primary" data-action="add-visit">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <div style="margin-top:8px">
            <div class="muted-sm">–ü—Ä–æ–≥—Ä–µ—Å—Å:</div>
            <div class="meter"><i id="visits-meter" style="width:0%"></i></div>
            <div class="muted-sm"><span id="visits-count">0</span>/3 –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</div>
          </div>
        </div>
      </template>

      <!-- ===== PAGES ===== -->
      <section class="page" id="home">
        <div class="hero">
          <img class="hero__media" src="beer_hero.jpg" alt="Beer Hero">
        </div>

        <div class="promo">
          <div class="promo__icon"><img src="ic_bonus.png" alt=""></div>
          <div>
            <div class="promo__title">Cap Toss ‚Äî —Å—ã–≥—Ä–∞–π —Å–µ–π—á–∞—Å</div>
            <div class="promo__sub">–ü–æ–ø–∞–¥–∞–Ω–∏—è ‚Üí –∫–æ–∏–Ω—ã ‚Üí –ø—Ä–∏–∑—ã</div>
          </div>
          <button class="promo__btn" data-open-sheet data-title="Cap Toss" data-tpl="#tpl-cap-toss">–ò–≥—Ä–∞—Ç—å</button>
        </div>

        <div class="card list-card tight">
          <div class="list-head">–° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å</div>
          <div class="list">
            <div class="list__item">
              <div class="list__icon"><img src="ic_services.png" alt=""></div>
              <div class="list__text">
                <div class="list__title">–ü–∏–≤–Ω–æ–π –ü–∞—Å–ø–æ—Ä—Ç</div>
                <div class="list__sub">–°–æ–±–µ—Ä–∏ 6 —à—Ç–∞–º–ø–æ–≤ ‚Äî –ø–æ–¥–∞—Ä–æ–∫</div>
              </div>
              <button class="list__chev-btn" data-open-sheet data-title="–ü–∏–≤–Ω–æ–π –ü–∞—Å–ø–æ—Ä—Ç" data-tpl="#tpl-passport">‚Ä∫</button>
            </div>
            <div class="list__item">
              <div class="list__icon"><img src="ic_bonus.png" alt=""></div>
              <div class="list__text">
                <div class="list__title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–ø–∏–Ω</div>
                <div class="list__sub">–ö—É–ª–¥–∞—É–Ω 24 —á, –º–µ–ª–∫–∏–µ –ø—Ä–∏–∑—ã</div>
              </div>
              <button class="list__chev-btn" data-open-sheet data-title="–ö–æ–ª–µ—Å–æ –ü–∏–≤–∞" data-tpl="#tpl-spin">‚Ä∫</button>
            </div>
            <div class="list__item">
              <div class="list__icon"><img src="ic_about.png" alt=""></div>
              <div class="list__text">
                <div class="list__title">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π</div>
                <div class="list__sub">+100 –∫–æ–∏–Ω–æ–≤ –∑–∞ –¥—Ä—É–≥–∞</div>
              </div>
              <button class="list__chev-btn" data-open-sheet data-title="–†–µ—Ñ–µ—Ä–∞–ª—ã" data-tpl="#tpl-ref">‚Ä∫</button>
            </div>
          </div>
        </div>
      </section>

      <section class="page" id="menu">
        <div class="card page-title">
          <div class="h1">–ú–µ–Ω—é –∏ –ª–∏–º–∏—Ç–∫–∏</div>
          <p class="muted-sm">–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ —É—Ä–æ–≤–Ω—é. (–º–∞–∫–µ—Ç—ã/–∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ–¥—Å—Ç–∞–≤—å –ø–æ–∑–∂–µ)</p>
          <div class="g g2">
            <button class="btn" data-open-sheet data-title="–í–∏–∫—Ç–æ—Ä–∏–Ω–∞" data-tpl="#tpl-trivia">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</button>
            <button class="btn" data-open-sheet data-title="–î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑–∏—Ç" data-tpl="#tpl-receipt">3 –≤–∏–∑–∏—Ç–∞ –∑–∞ 30</button>
          </div>
        </div>
      </section>

      <section class="page" id="games">
        <div class="card page-title">
          <div class="h1">–ò–≥—Ä—ã</div>
          <div class="g g2">
            <button class="btn btn-primary" data-open-sheet data-title="Cap Toss" data-tpl="#tpl-cap-toss">Cap Toss</button>
            <button class="btn" data-open-sheet data-title="–ö–æ–ª–µ—Å–æ –ü–∏–≤–∞" data-tpl="#tpl-spin">–ö–æ–ª–µ—Å–æ –ü–∏–≤–∞</button>
          </div>
        </div>
      </section>

      <section class="page" id="bonuses">
        <div class="card page-title">
          <div class="h1">–ë–æ–Ω—É—Å—ã</div>
          <div class="g">
            <div class="card">
              <div class="h1" style="margin:0">–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: <span id="level">Bronze</span></div>
              <p class="muted-sm">–ö–æ–∏–Ω—ã: <b id="coins-inline">0</b></p>
              <div class="meter"><i id="lvl-meter" style="width:0%"></i></div>
            </div>
            <button class="btn" data-open-sheet data-title="–ö–æ–ª–µ—Å–æ –ü–∏–≤–∞" data-tpl="#tpl-spin">–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ</button>
            <button class="btn" data-open-sheet data-title="–ü–∏–≤–Ω–æ–π –ü–∞—Å–ø–æ—Ä—Ç" data-tpl="#tpl-passport">–ü–∞—Å–ø–æ—Ä—Ç —Å—Ç–∏–ª–µ–π</button>
          </div>
        </div>
      </section>

      <section class="page" id="profile">
        <div class="card page-title">
          <div class="h1">–ü—Ä–æ—Ñ–∏–ª—å</div>
          <div class="g">
            <div class="card">
              <div class="g g2">
                <div>
                  <div class="muted-sm">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                  <div id="user-name" class="h1">‚Äî</div>
                </div>
                <div style="text-align:right">
                  <div class="muted-sm">–ö–æ–∏–Ω—ã</div>
                  <div class="h1" id="coins-profile">0</div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="muted-sm">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–∏–∑—ã</div>
              <div id="rewards-feed">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  (function app(){
    const TG = window.Telegram && window.Telegram.WebApp;
    if (TG){
      try{ TG.ready(); TG.expand(); TG.disableVerticalSwipes?.(); TG.enableClosingConfirmation?.(); TG.onEvent?.('viewportChanged', () => TG.disableVerticalSwipes?.()); }catch(e){ console.warn('TG init error', e); }
    }

    const ROOT = 'home';
    const sheetRoot = document.getElementById('sheet');
    const sheetPanel= sheetRoot?.querySelector('.sheet__panel');
    const sheetBody = document.getElementById('sheet-body');
    const sheetTitle= sheetRoot?.querySelector('.sheet__title');

    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const isInDOM = id => !!document.getElementById(id);

    function currentId(){
      const url = new URL(location.href);
      const qp = (url.searchParams.get('page') || '').trim();
      if (qp && isInDOM(qp)) return qp;
      const h = (location.hash || '#'+ROOT).replace(/^#/, '');
      return isInDOM(h) ? h : ROOT;
    }
    function setActivePage(id){
      qsa('main > section, section.page').forEach(s => {
        const on = (s.id === id);
        s.classList.toggle('active', on);
        s.style.display = on ? 'block' : 'none';
      });
      qsa('[data-page]').forEach(t => t.classList.toggle('active', t.dataset.page === id));
      requestAnimationFrame(()=> window.scrollTo({ top: 0, behavior:'auto' }));
      syncBack();
    }
    function navigateTo(id){
      if (!id || !isInDOM(id)) return;
      const h = '#'+id;
      if (h !== (location.hash || '#'+ROOT)){ history.pushState({id}, '', h); }
      setActivePage(id);
    }

    function showBack(){ try{ TG?.BackButton?.show && TG.BackButton.show(); }catch(_){ } }
    function hideBack(){ try{ TG?.BackButton?.hide && TG.BackButton.hide(); }catch(_){ } }
    function syncBack(){
      if (!TG) return;
      const atRoot = (currentId() === ROOT);
      const sheetOpen = sheetRoot?.classList.contains('is-open');
      if (sheetOpen || !atRoot) showBack(); else hideBack();
    }

    TG?.BackButton?.onClick?.(()=>{ if (sheetRoot && sheetRoot.classList.contains('is-open')){ closeSheet(); return; } const atRoot = (currentId() === ROOT); if (!atRoot) history.back(); });
    TG?.onEvent?.('backButtonClicked', ()=>{ if (sheetRoot && sheetRoot.classList.contains('is-open')){ closeSheet(); return; } const atRoot = (currentId() === ROOT); if (!atRoot) history.back(); });
    window.addEventListener('popstate', ()=> setActivePage(currentId()));

    function haptic(level='light'){ try{ TG?.HapticFeedback?.impactOccurred && TG.HapticFeedback.impactOccurred(level); } catch(_){ try{ navigator.vibrate && navigator.vibrate(level==='light'?10:16); }catch(_){} } }
    function openSheet({title='', html='', from='bottom'} = {}){
      if (!sheetRoot) return;
      sheetRoot.classList.toggle('sheet-bottom', from==='bottom');
      if (sheetTitle) sheetTitle.textContent = title || '';
      if (sheetBody && html != null) sheetBody.innerHTML = html;
      sheetRoot.classList.add('is-open'); document.body.classList.add('sheet-open');
      requestAnimationFrame(()=> sheetPanel?.focus({preventScroll:true}));
      haptic('light'); syncBack();
    }
    function closeSheet(){ if (!sheetRoot) return; sheetRoot.classList.remove('is-open'); document.body.classList.remove('sheet-open'); haptic('light'); syncBack(); }
    window.openSheet = openSheet; window.closeSheet = closeSheet;
    sheetRoot?.addEventListener('click', (e)=>{ if (e.target.closest('[data-close-sheet]')) closeSheet(); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && sheetRoot?.classList.contains('is-open')) closeSheet(); });

    // Prevent iOS pull-to-refresh when no TG.disableVerticalSwipes
    const isiOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    if (isiOS && !(TG && typeof TG.disableVerticalSwipes === 'function')){
      let startY = 0; document.addEventListener('touchstart', e => { startY = e.touches[0].clientY; }, {passive:true});
      document.addEventListener('touchmove', e => { const dy = e.touches[0].clientY - startY; const atTop = (window.scrollY <= 0); if (dy > 0 && atTop){ e.preventDefault(); } }, {passive:false});
    }

    // ===== Confetti (simple) =====
    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    function resizeCanvas(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    function confettiBurst(n=140, duration=900){
      const parts = Array.from({length:n},()=>({
        x: Math.random()*confettiCanvas.width,
        y: -10,
        vx: (Math.random()-0.5)*4,
        vy: Math.random()*3+2,
        r: Math.random()*3+1,
        a: 1
      }));
      const t0 = performance.now();
      function frame(t){
        const dt = (t - (confettiBurst._lt||t))/16; confettiBurst._lt = t;
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        parts.forEach(p=>{ p.x+=p.vx*dt; p.y+=p.vy*dt; p.a -= 0.01*dt; ctx.globalAlpha = Math.max(0,p.a); ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle = ['#f9b24d','#f29117','#ffd59c','#fff'][p.r|0 % 4]; ctx.fill(); });
        if (t - t0 < duration){ requestAnimationFrame(frame); } else { ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); }
      }
      requestAnimationFrame(frame);
    }

    // ===== App State & Storage =====
    const APP = {
      BOT_USERNAME: 'your_bot_username', // TODO: –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ @–∏–º—è_–±–æ—Ç–∞
      WORKER_BASE: 'https://your-worker.example.dev/', // TODO: –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Worker
      API_KEY: 'dev-123',
      COOLDOWN_SPIN_HOURS: 24,
      MAX_TRIVIA: 5,
    };
    const store = {
      get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch(_){ return def }},
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
      now(){ return Date.now(); }
    };
    const SKEY = {
      coins: 'beer_coins',
      spinAt: 'beer_spin_next',
      rewards: 'beer_rewards',
      passport: 'beer_passport',
      visits: 'beer_visits',
      trivia: 'beer_trivia',
    };
    function addCoins(n){ const c = Math.max(0, (store.get(SKEY.coins,0) + n)|0); store.set(SKEY.coins,c); syncCoins(); }
    function coins(){ return store.get(SKEY.coins,0)|0; }

    function syncCoins(){
      qsa('#coins,#coins-inline,#coins-profile').forEach(el=> el && (el.textContent = coins()));
      const lvl = levelFromCoins(coins());
      const pct = Math.min(100, (coins() % 1000)/10);
      const lvlEl = document.getElementById('level'); if (lvlEl) lvlEl.textContent = lvl;
      const lm = document.getElementById('lvl-meter'); if (lm) lm.style.width = pct+'%';
      const cm = document.getElementById('coin-meter'); if (cm) cm.style.width = Math.min(100, coins()/10)+'%';
    }
    function levelFromCoins(c){ if (c >= 3000) return 'Gold'; if (c >= 1500) return 'Silver'; return 'Bronze'; }

    // ===== Pages: Home interactions =====
    document.addEventListener('click', (e)=>{
      const openBtn = e.target.closest('[data-open-sheet]');
      if (openBtn){ e.preventDefault(); const tplSel = openBtn.dataset.tpl || ''; const tpl = tplSel ? document.querySelector(tplSel) : null; const html = tpl ? tpl.innerHTML : ''; const ttl = openBtn.getAttribute('title') || openBtn.dataset.title || openBtn.textContent.trim() || ''; const from = openBtn.dataset.from || 'bottom'; openSheet({ title: ttl, html, from }); initSheet(ttl); return; }
      const tab = e.target.closest('[data-page]'); if (tab){ e.preventDefault(); navigateTo(tab.dataset.page); }

      // sheet actions
      const act = e.target.closest('[data-action]')?.dataset.action;
      if (!act) return;
      switch(act){
        case 'start-cap': startCapToss(); break;
        case 'cap-help': alert('–°–≤–∞–π–ø–∞–π, —á—Ç–æ–±—ã –±—Ä–æ—Å–∞—Ç—å. –ö–æ–º–±–æ –∏ ¬´Foam Frenzy¬ª –ø–æ–∑–∂–µ –ø—Ä–∏–∫—Ä—É—Ç–∏–º.'); break;
        case 'spin': handleSpin(); break;
        case 'add-stamp': addStampPrompt(); break;
        case 'reset-passport': resetPassport(); break;
        case 'submit-trivia': submitTrivia(); break;
        case 'reset-trivia': resetTrivia(); break;
        case 'copy-ref': copyRef(); break;
        case 'share-ref': shareRef(); break;
        case 'add-visit': addVisit(); break;
      }
    });

    // ===== Router bootstrap =====
    const start = currentId(); history.replaceState({id:start}, '', '#'+start); setActivePage(start);
    setTimeout(()=>{ TG?.disableVerticalSwipes?.(); syncBack(); }, 0);
    setTimeout(()=>{ TG?.disableVerticalSwipes?.(); syncBack(); }, 300);

    // ===== User name in profile =====
    (function fillUser(){
      const u = TG?.initDataUnsafe?.user; const name = u ? (u.first_name + (u.last_name? (' ' + u.last_name) : '')) : '–ì–æ—Å—Ç—å';
      const nameEl = document.getElementById('user-name'); if (nameEl) nameEl.textContent = name;
    })();

    // ===== Sheet initializers =====
    function initSheet(title){
      if (/–ø–∞—Å–ø–æ—Ä—Ç/i.test(title)) renderPassport();
      if (/–∫–æ–ª–µ—Å–æ/i.test(title)) initSpin();
      if (/—Ä–µ—Ñ–µ—Ä–∞–ª|–¥—Ä—É–∑/i.test(title)) initRef();
      if (/–≤–∏–∫—Ç–æ—Ä–∏–Ω/i.test(title)) renderTrivia();
      if (/–≤–∏–∑–∏—Ç/i.test(title)) renderVisits();
      if (/cap toss/i.test(title)) initCapUI();
      syncCoins();
    }

    // ===== Spin logic =====
    const PRIZES = [
      {code:'nuts', title:'–û—Ä–µ—à–∫–∏', coins:50, weight:25},
      {code:'-5',   title:'–ö—É–ø–æ–Ω -5%', coins:80, weight:20},
      {code:'sticker', title:'–°—Ç–∏–∫–µ—Ä', coins:40, weight:22},
      {code:'x2',   title:'x2 –∫–æ–∏–Ω—ã –∑–∞ —Å–ª–µ–¥—É—é—â–∏–π —á–µ–∫ (48—á)', coins:0, weight:14},
      {code:'-10',  title:'–ö—É–ø–æ–Ω -10% (48—á)', coins:120, weight:10},
      {code:'rare', title:'–†–µ–¥–∫–∞—è –±–∞–Ω–∫–∞ (—á–µ–∫–æ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)', coins:200, weight:9},
    ];
    function rollPrize(){
      const total = PRIZES.reduce((s,p)=>s+p.weight,0); let r = Math.random()*total; for(const p of PRIZES){ if((r-=p.weight)<=0) return p; } return PRIZES[0];
    }
    function initSpin(){
      const next = store.get(SKEY.spinAt,0);
      const el = document.getElementById('spin-state');
      updateSpinState(el, next);
    }
    function updateSpinState(el, next){
      const now = store.now();
      if (now >= next){ el.textContent = '–ì–æ—Ç–æ–≤–æ –∫ –≤—Ä–∞—â–µ–Ω–∏—é'; } else {
        const left = Math.max(0, next - now); const h = Math.floor(left/3600000); const m = Math.floor((left%3600000)/60000);
        el.textContent = `–ö—É–ª–¥–∞—É–Ω: ${h}—á ${m}–º`;
      }
    }
    function handleSpin(){
      const el = document.getElementById('spin-state'); const next = store.get(SKEY.spinAt,0); const now = store.now();
      if (now < next){ haptic('light'); alert(el?.textContent || '–ö—É–ª–¥–∞—É–Ω'); return; }
      const prize = rollPrize();
      addCoins(prize.coins);
      logReward({source:'spin', prize:prize.title});
      confettiBurst(160, 1100); haptic('light');
      document.getElementById('spin-log')?.insertAdjacentHTML('afterbegin', `<div>üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: <b>${prize.title}</b> (+${prize.coins}ü™ô)</div>`);
      const newNext = now + APP.COOLDOWN_SPIN_HOURS*3600000;
      store.set(SKEY.spinAt, newNext);
      updateSpinState(el, newNext);
    }

    // ===== Rewards feed =====
    function logReward(rec){ const r = store.get(SKEY.rewards,[]); r.unshift({ts:Date.now(),...rec}); store.set(SKEY.rewards,r); renderRewards(); }
    function renderRewards(){
      const r = store.get(SKEY.rewards,[]); const box = document.getElementById('rewards-feed'); if (!box) return;
      if (!r.length){ box.textContent='–ü–æ–∫–∞ –ø—É—Å—Ç–æ'; return; }
      box.innerHTML = r.slice(0,8).map(x=>`<div>‚Ä¢ ${new Date(x.ts).toLocaleString()} ‚Äî ${x.source}: <b>${x.prize}</b></div>`).join('');
    }

    // ===== Passport =====
    const STYLES = ['Lager','IPA','Stout','Weizen','Sour','Cider'];
    function renderPassport(){
      const data = store.get(SKEY.passport, {});
      const grid = document.getElementById('passport-grid'); if (!grid) return;
      grid.innerHTML = STYLES.map(s=>{
        const c = data[s]||0; const done = c>0 ? 'badge badge--green' : 'badge';
        return `<div class="card" style="text-align:center"><div style="font-weight:800">${s}</div><div class="${done}" style="margin-top:6px">${c>0?'–®—Ç–∞–º–ø –µ—Å—Ç—å':'–ù–µ—Ç —à—Ç–∞–º–ø–∞'}</div></div>`;
      }).join('');
    }
    function addStampPrompt(){
      const style = prompt('–ö–∞–∫–æ–π —Å—Ç–∏–ª—å? (Lager, IPA, Stout, Weizen, Sour, Cider)'); if (!style) return;
      const S = style.trim(); if (!STYLES.includes(S)) return alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∏–ª—å');
      const pin = prompt('PIN —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–¥–µ–º–æ: 1111)'); if (pin !== '1111') return alert('PIN –Ω–µ–≤–µ—Ä–Ω—ã–π');
      const data = store.get(SKEY.passport, {}); data[S] = 1; store.set(SKEY.passport, data); renderPassport(); addCoins(100); confettiBurst(); logReward({source:'passport', prize:'–®—Ç–∞–º–ø '+S});
    }
    function resetPassport(){ store.set(SKEY.passport, {}); renderPassport(); }

    // ===== Trivia =====
    const TRIVIA = [
      {q:'–ö–∞–∫–æ–π —Å—Ç–∏–ª—å –æ–±—ã—á–Ω–æ –º—É—Ç–Ω—ã–π –∏ –±–∞–Ω–∞–Ω–æ–≤–æ‚Äë–≥–≤–æ–∑–¥–∏—á–Ω—ã–π?', a:['Lager','Weizen','Stout'], ok:1},
      {q:'IBU ‚Äî —ç—Ç–æ‚Ä¶', a:['–ì–æ—Ä–µ—á—å','–ü–ª–æ—Ç–Ω–æ—Å—Ç—å','–¶–≤–µ—Ç'], ok:0},
      {q:'–ß—Ç–æ —á–∞—â–µ –¥–∞—ë—Ç —Ç—Ä–æ–ø–∏–∫–∏?', a:['–ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π —Ö–º–µ–ª—å','–õ–∞–≥–µ—Ä–Ω—ã–µ –¥—Ä–æ–∂–∂–∏','–°–æ–ª–æ–¥ Pilsner'], ok:0},
      {q:'Stout –∞—Å—Å–æ—Ü–∏–∏—Ä—É—é—Ç —Å –Ω–æ—Ç–∞–º–∏‚Ä¶', a:['–ö–æ—Ñ–µ/—à–æ–∫–æ–ª–∞–¥','–õ–∞–π–º','–ó–µ–ª—ë–Ω–æ–µ —è–±–ª–æ–∫–æ'], ok:0},
      {q:'Sour ‚Äî —ç—Ç–æ‚Ä¶', a:['–ö–∏—Å–ª–æ–µ','–°—É–ø–µ—Ä–≥–æ—Ä—å–∫–æ–µ','–î—ã–º–Ω–æ–µ'], ok:0},
    ];
    function renderTrivia(){
      const f = document.getElementById('trivia-form'); if (!f) return;
      f.innerHTML = TRIVIA.slice(0,APP.MAX_TRIVIA).map((t,i)=>{
        return `<div class="card"><div style="font-weight:700">${i+1}. ${t.q}</div>${t.a.map((opt,idx)=>`<label style="display:block; margin-top:6px"><input type="radio" name="q${i}" value="${idx}"> ${opt}</label>`).join('')}</div>`;
      }).join('');
    }
    function submitTrivia(){
      let score=0; for(let i=0;i<APP.MAX_TRIVIA;i++){ const v = (new FormData(document.getElementById('trivia-form'))).get('q'+i); if (v!=null && +v===TRIVIA[i].ok) score++; }
      const res = document.getElementById('trivia-result'); res.textContent = `–í–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${score}/${APP.MAX_TRIVIA}`;
      if (score>=4){ addCoins(120); logReward({source:'trivia', prize:'–ö—É–ø–æ–Ω -10% (48—á)'}); confettiBurst(); haptic('light'); }
    }
    function resetTrivia(){ renderTrivia(); document.getElementById('trivia-result').textContent=''; }

    // ===== Referrals =====
    function initRef(){
      const u = TG?.initDataUnsafe?.user; const uid = u?.id || Math.floor(Math.random()*1e9);
      const code = 'beer_ref_'+uid;
      const link = `https://t.me/${APP.BOT_USERNAME}?start=${code}`;
      const input = document.getElementById('ref-link'); if (input) input.value = link;
    }
    async function copyRef(){ const el = document.getElementById('ref-link'); if(!el) return; el.select(); document.execCommand?.('copy'); try{ await navigator.clipboard.writeText(el.value); }catch{} haptic('light'); }
    async function shareRef(){ const el = document.getElementById('ref-link'); if(!el) return; const txt = '–ó–∞–ª–µ—Ç–∞–π –≤ –ø–∏–≤–Ω–æ–π –º–∏–Ω–∏‚Äë–∞–ø–ø –∏ –∑–∞–±–µ—Ä–∏ –ø—Ä–∏–∑! '+el.value; try{ await navigator.share?.({text:txt}); }catch{ try{ await navigator.clipboard.writeText(el.value);}catch{} } haptic('light'); }

    // ===== Visits (3 in 30 days) =====
    function renderVisits(){
      const list = store.get(SKEY.visits,[]).filter(x=> Date.now()-x.ts < 30*24*3600000);
      const cnt = list.length; const pct = Math.min(100, cnt/3*100);
      const m = document.getElementById('visits-meter'); if (m) m.style.width = pct+'%';
      const c = document.getElementById('visits-count'); if (c) c.textContent = cnt;
    }
    function addVisit(){
      const v = store.get(SKEY.visits,[]); const amt = parseFloat(document.getElementById('rcp-amount').value||'0')||0; v.push({ts:Date.now(), amount:amt}); store.set(SKEY.visits,v); renderVisits(); addCoins(80); logReward({source:'visit', prize:'–®–∞–≥ —Å–µ—Ä–∏–∏ 3 –∑–∞ 30'}); if (v.filter(x=> Date.now()-x.ts < 30*24*3600000).length>=3){ logReward({source:'series', prize:'–°–ø–∏–Ω ¬´–ö–æ–ª–µ—Å–∞ –ü–∏–≤–∞¬ª'}); confettiBurst(200,1200); }
    }

    // ===== Cap Toss (canvas visual demo with cups) =====
    let cap = {on:false, shots:0, score:0, t0:0, dur:30000, max:15};
    let capVis = null; // –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (canvas)

    function initCapUI(){
      const sEl = document.getElementById('cap-score'); if (sEl) sEl.textContent='0';
      const shEl = document.getElementById('cap-shots'); if (shEl) shEl.textContent='0/'+cap.max;
      const tEl = document.getElementById('cap-time'); if (tEl) tEl.textContent='00:30';

      const canvas = document.getElementById('cap-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      function resize(){
        const r = canvas.getBoundingClientRect();
        canvas.width = Math.max(320, Math.floor(r.width*devicePixelRatio));
        canvas.height= Math.max(200, Math.floor(r.height*devicePixelRatio));
      }
      resize();

      // —Ç—Ä–∏ ¬´–∫—Ä—É–∂–∫–∏¬ª (—Ç–∞—Ä–≥–µ—Ç—ã)
      const W = ()=>canvas.width, H = ()=>canvas.height;
      const cups = [
        {x:()=>W()*0.25, y:()=>H()*0.22, r:()=>28*devicePixelRatio, pts:100, color:'#f9b24d', name:'Lager'},
        {x:()=>W()*0.50, y:()=>H()*0.18, r:()=>28*devicePixelRatio, pts:150, color:'#ffd59c', name:'IPA'},
        {x:()=>W()*0.75, y:()=>H()*0.22, r:()=>28*devicePixelRatio, pts:200, color:'#f29117', name:'Stout'},
      ];

      capVis = { canvas, ctx, cups, proj:null, lastT:0, animId:0, resize };

      // –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
      drawCapScene();
      window.addEventListener('resize', ()=>{ resize(); drawCapScene(); }, {passive:true});
    }

    function drawCapScene(){
      if (!capVis) return;
      const {canvas, ctx, cups, proj} = capVis;
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      // —Ñ–æ–Ω
      const grd = ctx.createLinearGradient(0,0,0,H);
      grd.addColorStop(0,'rgba(255,255,255,0.06)');
      grd.addColorStop(1,'rgba(255,255,255,0.00)');
      ctx.fillStyle = grd; ctx.fillRect(0,0,W,H);

      // —á–∞—à–∫–∏/–º–∏—à–µ–Ω–∏
      cups.forEach((c,i)=>{
        ctx.beginPath(); ctx.arc(c.x(), c.y(), c.r(), 0, Math.PI*2);
        ctx.fillStyle = c.color; ctx.globalAlpha = 0.18; ctx.fill();
        ctx.globalAlpha = 1; ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(255,255,255,.35)'; ctx.stroke();
        ctx.font = `${12*devicePixelRatio}px Inter`; ctx.textAlign='center'; ctx.fillStyle = 'rgba(255,255,255,.85)';
        ctx.fillText(c.name, c.x(), c.y() - (c.r()+8*devicePixelRatio));
        ctx.fillText('+'+c.pts, c.x(), c.y() + (c.r()+14*devicePixelRatio));
      });

      // projectile (–∫—Ä—ã—à–∫–∞)
      if (proj){
        ctx.beginPath(); ctx.arc(proj.x, proj.y, 10*devicePixelRatio, 0, Math.PI*2);
        ctx.fillStyle = '#fff'; ctx.shadowColor='rgba(255,255,255,.6)'; ctx.shadowBlur=8*devicePixelRatio; ctx.fill(); ctx.shadowBlur=0;
      }
    }

    function startCapToss(){
      cap = {on:true, shots:0, score:0, t0:Date.now(), dur:30000, max:15};
      updateCapTime(); syncCapHUD();
      const area = document.getElementById('cap-area'); if(!area) return;

      // —Å–±—Ä–æ—Å —Å–ª—É—à–∞—Ç–µ–ª–µ–π –∏ —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
      const clone = area.cloneNode(true); area.parentNode.replaceChild(clone, area);
      const box = document.getElementById('cap-area');
      box.querySelector('.cap-msg')?.remove();

      // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–∞–Ω–≤–∞—Å –ø—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
      initCapUI();

      let down = null;
      const onDown = (e)=>{ down = {x:e.clientX, y:e.clientY, t:performance.now()}; };
      const onUp = (e)=>{ if (!cap.on) return; throwCap(down, {x:e.clientX, y:e.clientY, t:performance.now()}); };

      ['pointerdown','touchstart','mousedown'].forEach(ev=> box.addEventListener(ev, onDown, {passive:true}));
      ['pointerup','touchend','mouseup','click'].forEach(ev=> box.addEventListener(ev, onUp, {passive:true}));

      setTimeout(finishCap, cap.dur+120);
    }

    function throwCap(start, end){
      if (cap.shots>=cap.max) return;
      cap.shots++;

      // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è ‚Äî –Ω–∏–∂–Ω–∏–π —Ü–µ–Ω—Ç—Ä
      const {canvas} = capVis; const W = canvas.width, H = canvas.height;
      const sx = W*0.5, sy = H*0.86;

      // –°–∫–æ—Ä–æ—Å—Ç—å –∏–∑ –∂–µ—Å—Ç–∞, fallback ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –≤–≤–µ—Ä—Ö
      const dx = (end?.x||0) - (start?.x||0);
      const dy = (end?.y||0) - (start?.y||0);
      const dt = Math.max(1, (end?.t||0) - (start?.t||0));
      const speed = Math.min(1.8, Math.hypot(dx,dy)/Math.max(60,dt));
      const ang = Math.atan2(-Math.abs(dy)||-1, dx||0) || -1.2; // —É–≥–æ–ª –ø–æ–ª—ë—Ç–∞ (–≤–≤–µ—Ä—Ö)

      const v0 = (260 + Math.random()*90) * devicePixelRatio * (0.6 + 0.4*speed);
      const vx = v0 * Math.cos(ang) * 0.016; // px per frame
      const vy = v0 * Math.sin(ang) * 0.016;
      const g  = 9.8 * devicePixelRatio * 0.12; // gravity per frame

      capVis.proj = {x:sx, y:sy, vx, vy, g};
      haptic('light');
      animateProjectile();
    }

    function animateProjectile(){
      if (!capVis?.proj) return;
      const {canvas, cups} = capVis;
      const p = capVis.proj;
      const step = ()=>{
        if (!cap.on) return; // –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        // update
        p.x += p.vx; p.y += p.vy; p.vy += p.g;
        // collide with cups
        for(const c of cups){
          const dx = p.x - c.x(); const dy = p.y - c.y(); const hit = Math.hypot(dx,dy) <= c.r()+10*devicePixelRatio;
          if (hit){
            cap.score += c.pts;
            confettiBurst(80,700); haptic('light');
            capVis.proj = null; // –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            syncCapHUD();
            drawCapScene();
            return; // –±—Ä–æ—Å–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω
          }
        }
        // out of bounds
        if (p.y < 0 || p.x< -20*devicePixelRatio || p.x > canvas.width+20*devicePixelRatio || p.y > canvas.height+10*devicePixelRatio){
          capVis.proj = null; drawCapScene(); return;
        }
        drawCapScene();
        capVis.animId = requestAnimationFrame(step);
      };
      cancelAnimationFrame(capVis.animId); capVis.animId = requestAnimationFrame(step);
    }

    function syncCapHUD(){
      const sh = document.getElementById('cap-shots'); if (sh) sh.textContent = cap.shots+'/'+cap.max;
      const sc = document.getElementById('cap-score'); if (sc) sc.textContent = cap.score;
    }
    function updateCapTime(){
      if(!cap.on) return;
      const left = Math.max(0, cap.dur - (Date.now()-cap.t0));
      const s = Math.ceil(left/1000); const mm = String(Math.floor(s/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0');
      const el = document.getElementById('cap-time'); if (el) el.textContent = mm+':'+ss;
      if (left>0) requestAnimationFrame(updateCapTime);
    }
    function finishCap(){
      if(!cap.on) return; cap.on=false; capVis && cancelAnimationFrame(capVis.animId);
      const bonus = Math.floor(cap.score/10);
      addCoins(bonus);
      logReward({source:'cap_toss', prize:`–û—á–∫–∏ ${cap.score} ‚Üí +${bonus}ü™ô`});
      confettiBurst(180,1200); haptic('light');
    }

    // ===== Init state =====
    syncCoins(); renderRewards();
  })();
  </script>
</body>
</html>
