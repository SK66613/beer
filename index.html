<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BeerCraft • Mini‑App (clean build)</title>
  <style>
    :root { --gap:12px; --card: #101114; --ink:#e8eaf0; --muted:#9aa3ad; --ok:#17c964; --warn:#f5a524; --bad:#f31260; }
    html,body{margin:0;padding:0;background:#0b0c0f;color:var(--ink);font:14px/1.4 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}
    h2{margin:18px 0 12px}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(255,255,255,.05) inset}
    .row{display:grid;gap:var(--gap)}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted)}
    .kv{display:grid;grid-template-columns:auto 1fr;gap:8px 16px;align-items:center}
    .kv .v{font-weight:600}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0e1116;border:1px solid #1b2028}

    /* Passport sheet */
    .sheet{position:fixed;inset:auto 0 0 0;background:#0b0c0f;border-radius:16px 16px 0 0;transform:translateY(100%);transition:transform .3s ease;box-shadow:0 -20px 80px rgba(0,0,0,.4)}
    .sheet.is-open{transform:translateY(0)}
    .sheet__head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #171a20}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;padding:12px 16px 24px}
    .pslot{background:#0e1116;border:1px solid #1b2028;border-radius:12px;padding:10px;display:grid;gap:8px}
    .pslot h4{margin:0;font-size:13px}
    .pslot .pslot__badge{font-size:12px}
    .pslot.is-done{border-color:rgba(23,201,100,.5);box-shadow:0 0 0 1px rgba(23,201,100,.2) inset}
    .pslot.is-done .pslot__badge{color:var(--ok)}
    .sheet__foot{padding:8px 16px 14px;border-top:1px solid #171a20}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:38px;padding:0 14px;border-radius:10px;border:1px solid #2a313b;background:#151922;color:var(--ink);cursor:pointer}
    .btn--primary{background:#1b60f2;border-color:#1b60f2}

    /* Leaderboard */
    .tabs{display:inline-grid;grid-auto-flow:column;gap:8px;padding:6px;background:#0e1116;border:1px solid #1b2028;border-radius:999px}
    .tab{padding:6px 10px;border-radius:999px;border:0;cursor:pointer;background:transparent;color:var(--muted)}
    .tab.is-active{background:#1b60f2;color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #171a20;text-align:left}
    th{color:#9aa3ad;font-weight:500}

    @media (max-width:720px){
      .row.cols-2{grid-template-columns:1fr}
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
  </style>
</head>
<body data-api-base="">
  <div class="wrap">
    <h2>Профиль</h2>
    <div class="card row cols-2">
      <div class="kv">
        <div class="k muted">Монеты</div><div class="v" id="pf-coins">—</div>
        <div class="k muted">Штампы</div><div class="v"><span id="pf-pass-count">0/6</span> <span class="badge"><span class="muted">последний:</span> <span id="pf-last-stamp">—</span></span></div>
        <div class="k muted">Рефералы</div><div class="v" id="pf-refs-count">0</div>
        <div class="k muted">Шмель — лучший счёт</div><div class="v" id="pf-flappy-best">0</div>
        <div class="k muted">Турнир — место сегодня</div><div class="v" id="pf-today-rank">—</div>
        <div class="k muted">Турнир — место за всё время</div><div class="v" id="pf-all-rank">—</div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">Последние призы</div>
        <div id="pf-last-prizes" class="row"></div>
      </div>
    </div>

    <h2 style="margin-top:22px">Турнир</h2>
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div class="tabs" role="tablist">
          <button class="tab is-active" id="lb-tab-today" aria-selected="true">День</button>
          <button class="tab" id="lb-tab-all" aria-selected="false">Все</button>
        </div>
        <button class="btn" id="btn-refresh">Обновить</button>
      </div>
      <table>
        <thead><tr><th>#</th><th>Игрок</th><th>Счёт</th></tr></thead>
        <tbody id="leaderboard-body"><tr><td colspan="3" class="muted">Нет данных</td></tr></tbody>
      </table>
    </div>

    <h2 style="margin-top:22px">Паспорт стилей</h2>
    <div class="card">
      <button class="btn btn--primary" id="open-passport">Открыть паспорт</button>
    </div>
  </div>

  <!-- Sheet: Passport -->
  <div class="sheet" id="sheet" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet__head">
      <strong>Паспорт стилей</strong>
      <button class="btn" id="sheet-close">Закрыть</button>
    </div>
    <div class="grid" id="passport-grid">
      <!-- примеры карточек (замени на свои, важны data-style-id) -->
      <div class="pslot" data-style-id="Кружка"><h4>Кружка</h4><div class="pslot__badge">Получить</div></div>
      <div class="pslot" data-style-id="Футболка"><h4>Футболка</h4><div class="pslot__badge">Получить</div></div>
      <div class="pslot" data-style-id="Фисташки"><h4>Фисташки</h4><div class="pslot__badge">Получить</div></div>
      <div class="pslot" data-style-id="Скидка"><h4>Скидка</h4><div class="pslot__badge">Получить</div></div>
      <div class="pslot" data-style-id="Дегустация"><h4>Дегустация</h4><div class="pslot__badge">Получить</div></div>
      <div class="pslot" data-style-id="Монеты"><h4>Монеты</h4><div class="pslot__badge">Получить</div></div>
    </div>
    <div class="sheet__foot">
      <div class="muted">Нажмите на карточку, чтобы отметить штамп</div>
    </div>
  </div>

  <script>
  (function(){
    // ====== CONFIG ======
    const TG = (window.Telegram && Telegram.WebApp) || null;
    const API_BASE = document.body.dataset.apiBase || window.API_BASE || window.__API_BASE || ""; // e.g. "https://example.workers.dev"
    const DEMO_PIN = window.DEMO_PIN || '1111';

    // ====== STATE & CACHE ======
    const KEY_STATE   = 'beer_state_v3';
    const KEY_STAMPS  = 'beer_passport_v2'; // { stamps:[] }
    const KEY_COINS   = 'beer_coins_v2';
    const KEY_PRIZES  = 'beer_last_prizes_v2'; // { list:[] }

    let MiniState = null;  // последнее валидное состояние с воркера
    let KV_VER = 0;        // monotonic версия из воркера
    let CURRENT_LB = 'today';
    let pinOkSession = false; // подтверждённый PIN в рамках сессии

    // ====== HELPERS ======
    function getTgInit(){ try{ return TG?.initData || ''; }catch(_){ return ''; } }
    function jpost(path, body){
      return fetch((API_BASE||'')+path, {
        method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'}, cache:'no-store',
        body: JSON.stringify(body||{})
      }).then(r=>r.json()).catch(()=>({ok:false,error:'net'}));
    }

    function readJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)||''); }catch(_){ return fallback; } }
    function writeJSON(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(_){} }

    function effectiveStamps(state){
      const fromState = (state?.styles) || (state?.styles_user) || [];
      const fromLS = readJSON(KEY_STAMPS,{stamps:[]}).stamps || [];
      const set = new Set([...(fromState||[])].map(s=>String(s)));
      for (const s of fromLS){ set.add(String(s)); }
      return Array.from(set);
    }

    function computeMyRanks(st){
      const uid = String(TG?.initDataUnsafe?.user?.id || '');
      const uname = String(TG?.initDataUnsafe?.user?.username || '');
      const today = Array.isArray(st?.leaderboard_today)?st.leaderboard_today:[];
      const all   = Array.isArray(st?.leaderboard_alltime)?st.leaderboard_alltime:[];
      const isMe = r => String(r.tg_id||r.uid||'')===uid || (uname && r.username===uname);
      const ixToday = today.findIndex(isMe);
      const ixAll   = all.findIndex(isMe);
      const bestAll = (st?.my_best_score|0) || Math.max(0, ...all.filter(isMe).map(r=>r.score|0));
      return { rankToday: ixToday>=0 ? ixToday+1 : '—', rankAll: ixAll>=0 ? ixAll+1 : '—', best: bestAll||0 };
    }

    // ====== RENDER ======
    function paintBadgesFromState(state){
      const owned = new Set(effectiveStamps(state).map(s=>String(s).toLowerCase()));
      document.querySelectorAll('#passport-grid .pslot').forEach(card=>{
        const code = (card.getAttribute('data-style-id')||'').trim().toLowerCase();
        const ok = code && owned.has(code);
        card.classList.toggle('is-done', !!ok);
        const b = card.querySelector('.pslot__badge');
        if (b) b.textContent = ok ? 'Получен' : 'Получить';
      });
      // counters in profile
      const total = Number(MiniState?.styles_total || 6);
      const cntEl = document.getElementById('pf-pass-count'); if (cntEl) cntEl.textContent = `${owned.size}/${total}`;
      const lastEl = document.getElementById('pf-last-stamp'); if (lastEl) lastEl.textContent = MiniState?.last_stamp_name || MiniState?.last_stamp_id || '—';
    }

    function paintProfileFromState(state){
      // coins
      if (typeof state?.coins === 'number'){
        document.getElementById('pf-coins')?.replaceChildren(document.createTextNode(String(state.coins|0)));
        writeJSON(KEY_COINS, {v: state.coins|0});
      } else {
        const c = readJSON(KEY_COINS, {v:'—'}); document.getElementById('pf-coins')?.replaceChildren(document.createTextNode(String(c.v)));
      }
      // last prizes (array of strings)
      const lp = (Array.isArray(state?.last_prizes) ? state.last_prizes : (readJSON(KEY_PRIZES,{list:[]}).list || []));
      if (Array.isArray(state?.last_prizes)) writeJSON(KEY_PRIZES, {list: state.last_prizes});
      const box = document.getElementById('pf-last-prizes');
      if (box){ box.innerHTML = ''; (lp.slice(0,6)).forEach(p=>{ const t=document.createElement('span'); t.className='badge'; t.textContent=String(p); box.appendChild(t); }); }

      // refs
      const refs = Number(state?.ref_total || state?.ref_count || state?.refs || 0);
      document.getElementById('pf-refs-count')?.replaceChildren(document.createTextNode(String(refs)));

      // ranks + best
      const r = computeMyRanks(state);
      document.getElementById('pf-today-rank')?.replaceChildren(document.createTextNode(String(r.rankToday)));
      document.getElementById('pf-all-rank')?.replaceChildren(document.createTextNode(String(r.rankAll)));
      document.getElementById('pf-flappy-best')?.replaceChildren(document.createTextNode(String(r.best)));

      paintBadgesFromState(state);
      renderLeaderboard();
    }

    function renderLeaderboard(){
      const tb = document.getElementById('leaderboard-body'); if (!tb) return;
      const st = MiniState || readJSON(KEY_STATE, {});
      const rows = (CURRENT_LB==='today' ? (st.leaderboard_today||[]) : (st.leaderboard_alltime||[]));
      tb.innerHTML = '';
      if (!rows.length){ tb.innerHTML = '<tr><td class="muted" colspan="3">Нет данных</td></tr>'; return; }
      rows.slice(0,50).forEach((r,i)=>{
        const tr = document.createElement('tr');
        const td1=document.createElement('td'); td1.textContent=String(i+1);
        const td2=document.createElement('td'); td2.textContent=String(r.username||r.name||('id'+(r.tg_id||r.uid||'')));
        const td3=document.createElement('td'); td3.textContent=String(r.score|0);
        tr.append(td1,td2,td3); tb.appendChild(tr);
      });
    }

    // ====== APPLY STATE (single source of truth) ======
    function applyServerState(state){
      if (!state || state.ok===false) return;
      const v = Number(state.kv_ver||0);
      if (v && KV_VER && v <= KV_VER) return; // do not overwrite with older
      KV_VER = v || Date.now();
      MiniState = state;
      writeJSON(KEY_STATE, state);
      paintProfileFromState(state);
    }

    // ====== NETWORK ======
    async function fetchAndApplyState(opts){
      const s = await jpost('/api/mini/state', { tg_init:getTgInit(), fresh: opts?.fresh?1:0 });
      if (s && s.ok) applyServerState(s);
      return s;
    }

    // ====== SHEET (open/close) ======
    const sheet = document.getElementById('sheet');
    function openSheet(){ sheet?.classList.add('is-open'); sheet?.setAttribute('aria-hidden','false'); paintBadgesFromState(MiniState || readJSON(KEY_STATE,{})); }
    function closeSheet(){ sheet?.classList.remove('is-open'); sheet?.setAttribute('aria-hidden','true'); }

    document.getElementById('open-passport')?.addEventListener('click', openSheet);
    document.getElementById('sheet-close')?.addEventListener('click', closeSheet);

    // ====== COLLECT STYLE (PIN-gated, single prompt per session) ======
    let pinPromptInFlight = false;
    document.addEventListener('click', function(e){
      const tile = e.target.closest('#passport-grid .pslot');
      if (!tile) return;
      const sid = tile.getAttribute('data-style-id');
      if (!sid) return;
      e.preventDefault();
      (async ()=>{
        if (!pinOkSession){
          if (pinPromptInFlight) return; // guard from double-click
          pinPromptInFlight = true;
          const pin = prompt('PIN сотрудника (демо: 1111)');
          pinPromptInFlight = false;
          if (pin !== DEMO_PIN){ alert('PIN неверный'); return; }
          pinOkSession = true; try{ TG?.showPopup?.({message:'PIN ОК'}); }catch(_){}
        }
        // Only with confirmed PIN we send to worker
        const r = await jpost('/api/mini/event', { tg_init:getTgInit(), type:'style.collect', data:{ style_id:String(sid) } });
        if (r && r.ok && r.fresh_state){
          applyServerState(r.fresh_state);
        } else if (r && r.ok){
          // no fresh state – update local stamps optimistically
          const cur = readJSON(KEY_STAMPS,{stamps:[]});
          const stamps = Array.from(new Set([...(cur.stamps||[]), String(sid)]));
          writeJSON(KEY_STAMPS,{stamps});
          paintBadgesFromState(MiniState);
        } else {
          // network fail: keep local optimistic cache but DO NOT send if no PIN
          const cur = readJSON(KEY_STAMPS,{stamps:[]});
          const stamps = Array.from(new Set([...(cur.stamps||[]), String(sid)]));
          writeJSON(KEY_STAMPS,{stamps});
          paintBadgesFromState(MiniState);
        }
      })();
    }, {passive:false});

    // ====== TOURNAMENT TABS ======
    const tday = document.getElementById('lb-tab-today');
    const tall = document.getElementById('lb-tab-all');
    tday?.addEventListener('click', ()=>{ CURRENT_LB='today'; tday.classList.add('is-active'); tall.classList.remove('is-active'); renderLeaderboard(); });
    tall?.addEventListener('click', ()=>{ CURRENT_LB='all';   tall.classList.add('is-active'); tday.classList.remove('is-active'); renderLeaderboard(); });

    document.getElementById('btn-refresh')?.addEventListener('click', ()=>{ fetchAndApplyState({fresh:1}); });

    // ====== HEARTBEAT (мягкие «пинки») ======
    setInterval(()=>{ fetchAndApplyState({fresh:1}); }, 30000);
    document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) fetchAndApplyState({fresh:1}); });

    // ====== BOOT: load from cache first, then network ======
    (function boot(){
      const cached = readJSON(KEY_STATE, null);
      if (cached){ MiniState=cached; KV_VER=Number(cached.kv_ver||0); paintProfileFromState(cached); }
      fetchAndApplyState({fresh:1});
    })();

    // Optional: Telegram UI polish
    try{ TG?.ready?.(); TG?.expand?.(); }catch(_){}
  })();
  </script>
</body>
</html>
