<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Beer Mini‑App | Router + BackButton + No‑Swipe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --tabH: 64px;
      --navGap: 12px;
      --bg:#0b0c15; --text:#f4f6fa; --border:rgba(255,255,255,.10);
      --amber:#f9b24d; --green:#37d67a; --red:#ff6b6b; --blue:#3d7eff;
      --appW: 428px;
      --wrapPadX: 14px;
      --wrapPadTop: 16px;
    }
    *{ box-sizing:border-box }
    img{ max-width:100%; display:block }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.45 Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      overscroll-behavior: none;
    }
    @media (min-width:900px){ body{ display:grid; place-items:center; } }
    .wrap{
      width:100%; max-width:1080px; margin:0 auto;
      min-height:100svh;
      padding:16px 14px calc(var(--tabH) + var(--navGap) + env(safe-area-inset-bottom,0px) + 22px);
    }
    @media (min-width:900px){
      .wrap{ max-width:var(--appW); padding:20px 14px calc(var(--tabH) + var(--navGap) + env(safe-area-inset-bottom,0px) + 22px); }
    }
    main>section, section.page{ display:none }
    main>section.active, section.page.active{ display:block }

    /* bottom nav */
    .btm-nav{
      position:fixed; left:0; right:0;
      bottom: calc(var(--navGap) + env(safe-area-inset-bottom, 0px));
      height: var(--tabH);
      z-index: 9999;
      display:grid; grid-template-columns:repeat(5,1fr); align-items:center;
      padding: 6px 6px 6px;
      background: rgba(10,12,14,.72);
      -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.08);
      border-left:0; border-right:0; border-bottom:0;
      border-radius: 16px 16px 0 0;
    }
    .btm-nav .tab{
      height:100%; border:0; background:none; color:#dfe3e6; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      font-size:11px; font-weight:700;
      filter: grayscale(.35) saturate(.8); opacity:.85;
      border-radius:14px; -webkit-tap-highlight-color:transparent;
    }
    .btm-nav .tab img{ width:24px; height:24px }
    .btm-nav .tab:active{ transform: translateY(1px) }
    .btm-nav .tab.active{ opacity:1; filter:none; color:#fff; position:relative }
    .btm-nav .tab.active::before{
      content:""; position:absolute; inset:6px 10px 18px 10px; z-index:-1;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:12px;
    }
    @media (min-width:900px){
      .btm-nav{ left:50%; right:auto; width: var(--appW); transform: translateX(-50%); }
    }

    /* cards */
    .card{ background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:16px; padding:16px; }
    .page-title{ margin:0 0 12px }
    .h1{ font-weight:800; font-size:20px; margin:0 0 8px }
    .muted-sm{ opacity:.8 }

    /* sheet */
    .sheet{ position:fixed; inset:0; z-index:9990; pointer-events:none; }
    .sheet.is-open{ pointer-events:auto; }
    .sheet__overlay{
      position:absolute; left:0; right:0; top:0;
      bottom: calc(var(--tabH) + var(--navGap) + env(safe-area-inset-bottom, 0px));
      background: rgba(0,0,0,.48); opacity:0; transition:opacity .2s ease;
      -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px);
    }
    .sheet.is-open .sheet__overlay{ opacity:1; }
    .sheet__panel{
      position:absolute; left:0; right:0; margin:0 auto;
      width:min(820px,100%); max-height:88vh; overflow:auto;
      background:linear-gradient(180deg, rgba(18,20,24,.98), rgba(18,20,24,.96));
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 20px 40px rgba(0,0,0,.45);
      transition: transform .28s cubic-bezier(.2,.8,.2,1), opacity .2s ease;
      padding:12px 14px calc(16px + var(--tabH) + var(--navGap) + env(safe-area-inset-bottom, 0px));
      will-change: transform;
      touch-action: pan-y;
    }
    .sheet.sheet-bottom .sheet__panel{ bottom:0; top:auto; border-radius: 16px 16px 0 0; transform: translateY(100%); }
    .sheet.is-open.sheet-bottom .sheet__panel{ transform: translateY(0); }
    .sheet__handle{ width:42px; height:4px; border-radius:999px; margin:6px auto 10px; background:rgba(255,255,255,.18) }
    .sheet__header{ display:flex; align-items:center; gap:10px; margin:0 0 8px }
    .sheet__title{ font-weight:800; font-size:18px; margin:0 }
    .sheet__close{ margin-left:auto; border:0; background:transparent; color:#fff; opacity:.85; width:36px; height:36px; border-radius:10px; display:grid; place-items:center }
    .sheet__close:active{ transform:translateY(1px); opacity:1 }
    .sheet__body{ display:grid; gap:10px }
    body.sheet-open{ overflow:hidden }
    @media (min-width:900px){ .sheet__panel{ width:min(var(--appW),92vw); } }

    /* HERO */
    .hero{ position: relative; margin: calc(-1 * var(--wrapPadTop)) calc(-1 * var(--wrapPadX)) 14px; padding-top: env(safe-area-inset-top, 0px); background:#000; overflow:hidden; }
    .hero__media{ width:100%; height: clamp(260px, 42vh, 460px); object-fit: cover; display:block; }
    .hero::after{ content:""; position:absolute; left:0; right:0; bottom:-1px; height:84px; pointer-events:none; background:linear-gradient(180deg, rgba(0,0,0,0) 0%, var(--bg) 100%); }
    @media (min-width:900px){ .hero{ margin-left: calc((var(--appW) - 100vw)/2 - var(--wrapPadX)); margin-right: calc((var(--appW) - 100vw)/2 - var(--wrapPadX)); } }

    /* Promo */
    .promo{ display:grid; grid-template-columns:48px 1fr auto; align-items:center; gap:12px; padding:10px 12px; margin:0 0 12px; background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:16px; }
    .promo__icon{ width:48px; height:48px; border-radius:12px; display:grid; place-items:center; background:rgba(255,255,255,.06); overflow:hidden }
    .promo__icon img{ width:28px; height:28px; display:block }
    .promo__title{ font-weight:800 }
    .promo__sub{ opacity:.8; font-size:13px; margin-top:2px }
    .promo__btn{ height:36px; padding:0 14px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:linear-gradient(180deg,#f9b24d,#f29117); color:#16181e; font-weight:900; cursor:pointer; }
    .promo__btn:active{ transform: translateY(1px) }

    /* List */
    .list-card .list-head{ font:800 16px/1.2 Inter,system-ui; margin-bottom:8px }
    .list{ display:grid; gap:8px }
    .list-card .list__item{ background:transparent; border:0; box-shadow:none }
    .list-card.tight .list{ margin-left:-16px; margin-right:-16px }
    .list-card.tight .list__item{ padding:12px 16px; gap:10px; display:grid; grid-template-columns:36px 1fr auto; align-items:center; }
    .list-card.tight .list__icon{ width:36px; height:36px; border-radius:10px; display:grid; place-items:center; background:rgba(255,255,255,.06); overflow:hidden }
    .list-card.tight .list__icon img{ width:22px; height:22px; display:block }
    .list__text{ display:grid; gap:4px }
    .list__title{ font-weight:800 }
    .list__sub{ opacity:.8; font-size:13px }
    .list__chev-btn{ width:36px; height:36px; display:grid; place-items:center; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:transparent; color:inherit; font-size:18px; cursor:pointer; }
    .list__chev-btn:active{ transform:translateY(1px) }
    .list-card .list__item:hover{ background: rgba(255,255,255,.04) }

    /* badges, meters */
    .badge{ display:inline-grid; place-items:center; padding:3px 8px; border-radius:999px; font:700 12px/1 Inter; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); }
    .badge--amber{ background:rgba(249,178,77,.15); border-color:rgba(249,178,77,.35); color:#ffd59c }
    .badge--green{ background:rgba(55,214,122,.15); border-color:rgba(55,214,122,.35); color:#bff5d6 }
    .meter{ height:8px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden }
    .meter>i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#f9b24d,#f29117); }

    /* buttons */
    .btn{ height:40px; padding:0 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:#fff; font-weight:800; cursor:pointer }
    .btn:active{ transform: translateY(1px) }
    .btn-primary{ background:linear-gradient(180deg,#f9b24d,#f29117); color:#16181e; border:0 }

    /* grid small */
    .g{ display:grid; gap:10px }
    .g2{ grid-template-columns:1fr 1fr }
    .g3{ grid-template-columns:1fr 1fr 1fr }
    @media (max-width:420px){ .g2,.g3{ grid-template-columns:1fr } }

    /* Cap Toss area – reliable pointer input */
    #cap-area{ touch-action:none; user-select:none; -webkit-user-select:none; position:relative; margin-top:10px; height:260px; border:1px dashed rgba(255,255,255,.18); border-radius:12px; overflow:hidden; background:radial-gradient(120% 120% at 50% 100%, rgba(249,178,77,.12), rgba(255,255,255,.02)); }
    #cap-area canvas{ position:absolute; inset:0; width:100%; height:100%; display:block }
    #cap-area .cap-msg{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); opacity:.8; font-size:14px; text-align:center }

    /* confetti canvas */
    #confetti{ position:fixed; inset:0; pointer-events:none; z-index:99999; }
  </style>

  <style>

/* ===== Слайдер Slider ===== */
:root{ --introBottomPad: 28px; } /* насколько выше кнопки от нижней перекладины */

.intro{
  position:fixed; inset:0; z-index:10050;
  background:#000; color:#fff;
  display:none; pointer-events:auto;
}
.intro.is-open{ display:block; }
body.intro-open{ overflow:hidden; }

.intro__wrap{
  position:absolute; inset:0;
  display:flex; flex-direction:column;
  padding:
    calc(env(safe-area-inset-top,0px) + 6px)
    14px
    calc(env(safe-area-inset-bottom,0px) + var(--introBottomPad));
}

.intro__progress{
  display:flex; gap:8px; justify-content:center;
  padding:8px 0 12px;
}
.intro__seg{ width:44px; height:4px; border-radius:999px; background:rgba(255,255,255,.28) }
.intro__seg.active{ background:#fff }

.intro__stage{
  flex:1; display:grid; place-items:center; padding:12px; text-align:center;
}
.intro__slides{ width:100% }
.intro__slide{ display:none }
.intro__slide.active{ display:block }

.intro__h1{ font-weight:900; font-size:28px; margin:0 0 10px }
.intro__p{ opacity:.85; font-size:15px; margin:0 auto; max-width:26ch }

/* низ экрана — динамически рендерим набор кнопок */
.intro__actions{
  margin-top:auto; display:grid; gap:10px;
  padding-top:8px;
}
.intro__actions--one{ grid-template-columns:1fr }
.intro__actions--two{ grid-template-columns:1fr 1fr }

.intro__btn{
  height:52px; padding:0 16px; border-radius:16px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  color:#fff; font-weight:800; cursor:pointer;
}
.intro__btn--primary{ background:#fff; color:#000; border-color:#fff }
.intro__btn--ghost{ background:transparent }
.intro__btn:active{ transform:translateY(1px) }

@media (min-width:900px){
  .intro__wrap{ max-width: var(--appW,428px); margin:0 auto }
}
</style>

<style>
  /* ===== GAMES CARD Карточки на главной игры ===== */
.list-card.games .list__item{ background:transparent; border:0; box-shadow:none }
.list__btn{
  height:36px; padding:0 14px; border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:#fff; font-weight:800; cursor:pointer;
}
.list__btn--primary{ background:#fff; color:#000; border-color:#fff }
.list__btn:active{ transform:translateY(1px) }

/* чуть плотнее сетка под кнопку справа */
.list-card.games.tight .list__item{
  grid-template-columns:36px 1fr auto;
}
:root{ --gap-block: 16px; }           /* подправь число при желании */
.card.list-card.games{ margin-top: var(--gap-block); }

 </style>

 <style>
  /* ===== LEADERBOARD Турнир (Clicker) ===== */
.lb-card { padding:12px; }
.lb-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.lb-title{ font-weight:900; font-size:18px; }
.lb-sub{ opacity:.75; font-weight:600; font-size:12px; }

.lb-seg{
  display:inline-grid; grid-auto-flow:column; gap:6px; padding:4px; border-radius:999px;
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
}
.lb-seg button{
  height:30px; min-width:86px; padding:0 12px; border-radius:999px; border:0; cursor:pointer;
  font-weight:800; color:#fff; background:transparent;
}
.lb-seg button[aria-pressed="true"]{ background:#fff; color:#000; }

.lb-you{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
  margin-bottom:10px;
}
.lb-you__avatar{
  width:36px; height:36px; border-radius:10px; background:#222; display:grid; place-items:center; font-weight:900;
}
.lb-you__name{ font-weight:800; }
.lb-you__score{ margin-left:auto; font-weight:900; }

.lb-list{ display:flex; flex-direction:column; gap:8px; }
.lb-row{
  display:grid; grid-template-columns:28px 36px 1fr auto; align-items:center; gap:10px;
  padding:10px 12px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); border-radius:14px;
}
.lb-rank{ font-weight:900; opacity:.9; text-align:center; }
.lb-avatar{ width:36px; height:36px; border-radius:10px; background:#1b1c22; display:grid; place-items:center; font-weight:900; }
.lb-name{ font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.lb-score{ font-weight:900; }

.lb-medal-1 .lb-rank{ color:#ffd34d; }
.lb-medal-2 .lb-rank{ color:#cbd3ff; }
.lb-medal-3 .lb-rank{ color:#ffb27a; }

.lb-actions{ display:flex; gap:10px; margin-top:12px; }
.lb-btn{
  flex:1; height:42px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06); color:#fff; font-weight:800; cursor:pointer;
}
.lb-btn--primary{ background:#fff; color:#000; border-color:#fff; }

@media (min-width:900px){
  #leaderboard .inner{ max-width: var(--appW, 428px); margin:0 auto; }
}

 </style>

<style>
/* ===== FLAPPY LITE+ Шмель  (overlay) ===== */
.flappy{ position:fixed; inset:0; z-index:10060; background:#000; color:#fff; display:none; }
.flappy.is-open{ display:block; }
body.flappy-open{ overflow:hidden; }

.flappy__wrap{
  position:absolute; inset:0; display:flex; flex-direction:column;
  padding: calc(env(safe-area-inset-top,0px)+8px) 14px calc(env(safe-area-inset-bottom,0px)+14px);
}

/* HUD */
.fl-hud{ width:100%; max-width:520px; margin:0 auto 8px; }
.fl-hud__row{ display:grid; justify-items:center; gap:6px; }
.fl-score{ font:900 clamp(28px,8vw,48px)/1 Inter,system-ui; text-shadow:0 2px 10px rgba(0,0,0,.25) }
.fl-bar{ width:100%; height:4px; border-radius:999px; background:rgba(255,255,255,.18); overflow:hidden }
.fl-bar>i{ display:block; height:100%; width:100%; background:#fff; transform-origin:left center; }

/* HUD: coins + shield */
.fl-stats{ display:flex; justify-content:center; gap:14px; margin-top:6px; }
.fl-stat{ display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); font:800 13px/1 Inter;
}
.fl-ico{ width:18px; height:18px; background:center/contain no-repeat; opacity:.95 }
#fl-coin-count{ font:800 14px/1 Inter }
.fl-shield-wrap{ display:flex; align-items:center; gap:8px; }
.fl-shield-bar{ width:88px; height:4px; border-radius:999px; background:rgba(255,255,255,.18); overflow:hidden }
.fl-shield-bar>i{ display:block; height:100%; width:100%; background:#6be3ff; transform-origin:left center; }

/* Stage */
.fl-stage{ flex:1; position:relative; overflow:hidden; border-radius:16px;
  background: linear-gradient(180deg,#0a0c14 0%, #0f1626 100%);
}
.fl-hint{
  position:absolute; left:0; right:0; top:18%;
  text-align:center; font:800 16px/1.2 Inter; opacity:.75; pointer-events:none;
}

/* Sprites sizes (override via JS) */
:root{ --bird-w: 48px; --bird-h: 36px; --pipe-w: 76px; --coin-w: 32px; --coin-h: 32px; --pow-w: 34px; --pow-h: 34px; }

/* Bird */
.fl-bird{
  position:absolute; width:var(--bird-w); height:var(--bird-h); transform:translate(-50%,-50%) rotate(0deg);
  background: radial-gradient(circle at 35% 35%, #ffdd66, #ff9a00);
  border-radius:14px; box-shadow:0 8px 18px rgba(255,154,0,.35), inset 0 0 10px rgba(255,255,255,.25);
  will-change: transform, top, left;
}
.fl-bird--sprite{ background:center/contain no-repeat; border-radius:0; box-shadow:none; }
.fl-bird--shield{ box-shadow:0 0 0 3px rgba(107,227,255,.8), 0 0 30px rgba(107,227,255,.55); }

/* Pipes */
.fl-pipe-part{
  position:absolute; width:var(--pipe-w);
  background: linear-gradient(180deg,#6BFF7A,#1ED760);
  border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 22px rgba(30,215,96,.25), inset 0 0 10px rgba(255,255,255,.15);
}
.fl-pipe--sprite{ background: center / 100% 100% no-repeat; border:none; box-shadow:none; }

/* Items: coin & shield power-up */
.fl-coin,.fl-power{
  position:absolute; transform:translate(-50%,-50%); will-change: left, top;
  width:var(--coin-w); height:var(--coin-h); background:center/contain no-repeat;
}
.fl-power{ width:var(--pow-w); height:var(--pow-h); }

/* Result */
.fl-result{ position:absolute; inset:0; display:none; place-items:center; padding:16px; }
.fl-result.show{ display:grid; }
.fl-card{
  width:min(100%,520px); background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
  border-radius:18px; padding:12px 16px; display:grid; grid-template-columns:1fr 1fr auto; gap:14px; align-items:center;
}
.fl-cell{ display:grid; gap:4px; justify-items:center }
.fl-val{ font:800 20px/1 Inter } .fl-sub{ font:600 12px/1.1 Inter; opacity:.8 } .fl-chev{ font:20px/1 Inter; opacity:.6 }

/* CTA bottom (safe-area) */
:root{ --ctaGap: 44px; }
.fl-cta{ position:absolute; left:14px; right:14px; bottom: calc(env(safe-area-inset-bottom,0px) + var(--ctaGap)); display:none; }
.fl-cta.show{ display:block; }
.fl-cta .btn{ width:100%; height:52px; border-radius:16px; font:800 16px/1 Inter; background:#fff; color:#000; border:1px solid #fff; }

@media (min-width:900px){ .flappy__wrap{ max-width:var(--appW,428px); margin:0 auto } }

/* === ТЮНИНГ ЩИТА И РАДИУСОВ === */
:root{
  --bird-radius: 27px;                 /* скругление птички (в т.ч. со спрайтом) */
  --shield-ring: 1px;                  /* толщина «кольца» щита */
  --shield-ring-color: rgba(107,227,255,.95);
  --shield-glow-color: rgba(107,227,255,.55);
  --shield-glow-blur: 28px;            /* сила внешнего свечения */
  --shield-pulse: 1.6s;                /* скорость пульса ауры */
}

/* птичка всегда со скруглением через переменную */
.fl-bird{ border-radius: var(--bird-radius); }

/* если используешь спрайт — НЕ обнуляем радиус, пусть берёт var(--bird-radius) */
.fl-bird--sprite{ border-radius: var(--bird-radius); }

/* активный щит: кольцо + внешняя подсветка + мягкий пульс */
.fl-bird--shield{
  box-shadow: 0 0 var(--shield-glow-blur) var(--shield-glow-color);
  position: relative;
}
.fl-bird--shield::after{
  content:"";
  position:absolute; inset: calc(-1*var(--shield-ring));
  border-radius: inherit;
  border: var(--shield-ring) solid var(--shield-ring-color);
  box-shadow: 0 0 var(--shield-glow-blur) var(--shield-glow-color);
  animation: shieldPulse var(--shield-pulse) ease-in-out infinite;
  pointer-events: none;
}

@keyframes shieldPulse{
  0%  { box-shadow: 0 0 var(--shield-glow-blur) var(--shield-glow-color), 0 0 0 0 rgba(107,227,255,.35); }
  60% { box-shadow: 0 0 calc(var(--shield-glow-blur)*1.2) var(--shield-glow-color), 0 0 0 10px rgba(107,227,255,0); }
  100%{ box-shadow: 0 0 var(--shield-glow-blur) var(--shield-glow-color), 0 0 0 0 rgba(107,227,255,0); }
}
</style>

  <style>
    /* ===== BONUSES (чистая версия) ===== */

    /* Отступы между карточками в разделе */
    #bonuses>.card {
      margin-top: 14px;
    }

    #bonuses>.card:first-child {
      margin-top: 0;
    }

    /* Заголовок карточки */
    #bonuses .bonus-card {
      padding: 14px;
      overflow: hidden;
    }

    #bonuses .bonus-card .h2 {
      margin: 0 0 8px;
      font-weight: 800;
    }

    /* Хедер: слева плашка с выбранным бонусом */
    .bonus-head {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin: 0 0 10px;
    }

    .picked-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 40px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border, rgba(255, 255, 255, .12));
      background: rgba(255, 255, 255, .04);
      font-weight: 700;
    }

    .picked-pill img {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      object-fit: cover;
      display: block;
    }

    .picked-pill.muted {
      opacity: .7;
      font-weight: 600;
      background: linear-gradient(135deg, rgba(61, 224, 197, .12), rgba(123, 91, 255, .16));
    }

    /* Колесо — устойчивое, фиксированной высоты */
    .bonus-wheel {
      position: relative;
      height: 180px;
      /* фикс высота — не появится прокрутка */
      overflow: hidden;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, 0) 60%);
      margin-top: 6px;
    }

    .bonus-wheel .wheel-track {
      position: relative;
      width: 100%;
      height: 100%;
      touch-action: pan-x;
      user-select: none;
      cursor: grab;
    }

    .bonus-card.dragging .wheel-track {
      cursor: grabbing;
    }

    /* Карточка бонуса */
    .bonus-wheel .bonus {
      all: unset;
      position: absolute;
      left: 50%;
      top: 50%;
      width: 96px;
      height: 96px;
      border-radius: 16px;
      overflow: hidden;
      transform: translate(-50%, -50%);
      will-change: transform;
      transition: transform .25s ease, filter .25s ease, opacity .25s ease, box-shadow .25s ease;
    }

    .bonus-wheel .bonus img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .bonus-wheel .bonus span {
      position: absolute;
      left: 50%;
      bottom: -22px;
      transform: translateX(-50%);
      font-size: 12px;
      opacity: .85;
      white-space: nowrap;
      pointer-events: none;
    }

    .bonus-wheel .bonus:not(.active) {
      filter: grayscale(.18) brightness(.95);
      opacity: .9;
    }

    .bonus-wheel .bonus.active {
      box-shadow:
        0 0 0 2px rgba(123, 91, 255, .55) inset,
        0 10px 28px rgba(123, 91, 255, .35),
        0 0 22px rgba(61, 224, 197, .25);
    }

    /* Мягкая подсветка центра (опционально) */
    .bonus-wheel .wheel-center {
      pointer-events: none;
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center, rgba(123, 91, 255, .10), transparent 55%);
      mask: linear-gradient(#000 30%, transparent 80%);
    }

    /* Нижняя панель действий: Крутануть + Забрать + статус */
    .bonus-card .actions {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      align-items: center;
    }

    #spinBtn,
    #claimBtn {
      min-height: 40px;
    }

    #claimBtn[disabled] {
      opacity: .6;
      pointer-events: none;
    }

    #picked {
      opacity: .8;
    }

    /* Хедер сверху — только плашка */
    .bonus-head {
      display: flex;
      gap: 12px;
      margin: 0 0 10px;
    }

    .picked-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border, rgba(255, 255, 255, .12));
      background: rgba(255, 255, 255, .04);
      font-weight: 700;
    }

    .picked-pill.muted {
      opacity: .7;
      font-weight: 600;
    }

    /* Низ: две кнопки рядом + статус */
    .bonus-card .actions {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      /* [Крутануть] [Забрать] [—] */
      gap: 8px;
      align-items: center;
    }

    #spinBtn,
    #claimBtn {
      min-height: 40px;
    }

    #claimBtn[disabled] {
      opacity: .6;
      pointer-events: none;
    }

    #picked {
      opacity: .8;
    }
  </style>

<style>
  /* Toasts ТОСТ ОКОШКО*/
.toasts{
  position:fixed; right:16px; bottom:calc(env(safe-area-inset-bottom,0px) + 16px);
  z-index:100000; display:grid; gap:8px; width:min(92vw,320px); pointer-events:none;
}
.toast{
  pointer-events:auto; display:flex; align-items:center; gap:10px;
  padding:12px 14px; border-radius:14px; color:#fff;
  background:rgba(18,20,24,.96); border:1px solid rgba(255,255,255,.12);
  box-shadow:0 10px 24px rgba(0,0,0,.35);
  transform:translateX(120%); opacity:0; animation:toast-in .25s ease forwards;
}
.toast--error{ border-color:rgba(255,107,107,.45); box-shadow:0 10px 24px rgba(255,107,107,.15); }
.toast--ok{    border-color:rgba(55,214,122,.45);  box-shadow:0 10px 24px rgba(55,214,122,.15); }
.toast__close{ margin-left:auto; opacity:.7; background:transparent; border:0; color:inherit; cursor:pointer; }
@keyframes toast-in { to { transform:translateX(0); opacity:1; } }
@keyframes toast-out{ to { transform:translateX(120%); opacity:0; } }

/* визуально «заблокируем», но клики ловим для тоста */
#spinBtn.is-locked{ opacity:.6; }
#spinBtn.is-locked:active{ transform:none; }

</style>


</head>
<body>

  <canvas id="confetti"></canvas>
  <div class="wrap">
    <nav id="btm-nav" class="btm-nav" aria-label="Навигация">
      <button class="tab" data-page="home"><img src="ic_home.png" alt=""><span>Главная</span></button>
      <button class="tab" data-page="leaderboard"><img src="ic_services.png" alt=""><span>Турнир</span></button>
      <button class="tab" data-open-flappy><img src="ic_consult.png" alt=""><span>Играть</span></button>
      <!-- <button class="tab" data-page="games"><img src="ic_consult.png" alt=""><span>Играть</span></button> -->
      <button class="tab" data-page="bonuses"><img src="ic_bonus.png" alt=""><span>Бонусы</span></button>
      <button class="tab" data-page="profile"><img src="ic_about.png" alt=""><span>Профиль</span></button>
    </nav>

    <main>
<!-- ТОСТ Окошко поп апп всплывающее -->
      <div id="toasts" class="toasts" aria-live="polite"></div>



      <!-- Слайды Slider -->

<div id="intro" class="intro" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="intro__wrap">
    <div class="intro__progress" id="intro-progress"></div>

    <div class="intro__stage">
      <div class="intro__slides" id="intro-slides">
        <!-- 1 -->
        <section class="intro__slide active">
          <h2 class="intro__h1">Welcome fren</h2>
          <p class="intro__p">Подтверди, что тебе точно уже есть 18+.</p>
        </section>
        <!-- 2 -->
        <section class="intro__slide">
          <h2 class="intro__h1">Коротко о нас</h2>
          <p class="intro__p">У нас кравтовое пиво собственного производства. варим так сказать по дедушкину рецепту</p>
        </section>

        <!-- 3 -->
        <section class="intro__slide">
          <h2 class="intro__h1">Что тут делать</h2>
          <p class="intro__p">В этом мини апп ты можешь играть и выигрывать бонусы и цееные призы, начни с рулеточки</p>
        </section>

                <!-- 4 -->
        <section class="intro__slide">
          <h2 class="intro__h1">Отлично!</h2>
          <p class="intro__p">Ну все начали бро, жми кнопку и погнали</p>
        </section>
      </div>
    </div>

    <!-- сюда JS будет рендерить нужный набор кнопок -->
    <div id="intro-actions" class="intro__actions"></div>
  </div>
</div>


<!-- FLAPPY LITE+ ШМЕЛЬ (overlay) -->
<div id="flappy" class="flappy" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="flappy__wrap">
    <!-- HUD -->
    <div class="fl-hud">
      <div class="fl-hud__row">
        <div id="fl-score" class="fl-score">0</div>
        <div class="fl-bar"><i id="fl-bar"></i></div>
      </div>
      <div class="fl-stats">
        <div class="fl-stat">
          <i id="fl-coin-ico" class="fl-ico"></i>
          <span id="fl-coin-count">0</span>
        </div>
        <div class="fl-stat fl-shield-wrap">
          <i id="fl-shield-ico" class="fl-ico"></i>
          <div class="fl-shield-bar"><i id="fl-shield-bar"></i></div>
        </div>
      </div>
    </div>

    <!-- STAGE -->
    <div id="fl-stage" class="fl-stage">
      <div id="fl-hint" class="fl-hint">tap to fly</div>
      <div id="fl-bird" class="fl-bird" aria-label="bird"></div>

      <!-- RESULT -->
      <div id="fl-result" class="fl-result" aria-hidden="true">
        <div class="fl-card">
          <div class="fl-cell"><div class="fl-val" id="fl-best">0</div><div class="fl-sub">your best</div></div>
          <div class="fl-cell"><div class="fl-val" id="fl-world">200</div><div class="fl-sub">world record</div></div>
          <div class="fl-chev">›</div>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div id="fl-cta" class="fl-cta">
      <button class="btn" data-close-flappy>Play again</button>
    </div>
  </div>
</div>


















      <!-- Bottom Sheet -->
      <div id="sheet" class="sheet sheet-bottom" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="sheet__overlay" data-close-sheet></div>
        <section class="sheet__panel" tabindex="-1">
          <div class="sheet__handle"></div>
          <header class="sheet__header">
            <h3 class="sheet__title">Заголовок</h3>
            <button class="sheet__close" aria-label="Закрыть" data-close-sheet>✕</button>
          </header>
          <div class="sheet__body" id="sheet-body"></div>
        </section>
      </div>

      <!-- ===== Templates for sheets ===== -->
      <template id="tpl-cap-toss">
        <div class="card">
          <div class="h1">Cap Toss — брось крышку!</div>
          <p class="muted-sm">За 30 секунд накидай очков. Попадания → коины. Античит, вибро, конфетти — всё как любим.</p>
          <div class="g g2">
            <button class="btn btn-primary" data-action="start-cap">Старт (30 сек)</button>
            <button class="btn" data-action="cap-help">Правила</button>
          </div>
          <div id="cap-area">
            <canvas id="cap-canvas"></canvas>
            <div class="cap-msg">Свайпни/тапни, чтобы бросить крышку</div>
          </div>
          <div class="g g3" style="margin-top:10px">
            <div class="card" style="text-align:center">
              <div class="muted-sm">Очки</div>
              <div id="cap-score" class="h1">0</div>
            </div>
            <div class="card" style="text-align:center">
              <div class="muted-sm">Броски</div>
              <div id="cap-shots" class="h1">0/15</div>
            </div>
            <div class="card" style="text-align:center">
              <div class="muted-sm">Время</div>
              <div id="cap-time" class="h1">00:30</div>
            </div>
          </div>
        </div>
      </template>

      <template id="tpl-passport">
        <div class="card">
          <div class="h1">Пивной Паспорт стилей</div>
          <p class="muted-sm">Собери 6 штампов (Lager, IPA, Stout, Weizen, Sour, Cider) — приз.</p>
          <div class="g g3" id="passport-grid"></div>
          <div class="g g2" style="margin-top:8px">
            <button class="btn" data-action="add-stamp">Добавить штамп</button>
            <button class="btn" data-action="reset-passport">Сбросить</button>
          </div>
        </div>
      </template>

      <template id="tpl-spin">
        <div class="card">
          <div class="h1">Колесо Пива — ежедневный спин</div>
          <div id="spin-state" class="muted-sm">Проверяем кулдаун…</div>
          <div class="g" style="margin-top:8px">
            <button class="btn btn-primary" data-action="spin">Крутить</button>
            <div class="meter"><i id="coin-meter"></i></div>
            <div><span class="badge badge--amber">Коины: <b id="coins">0</b></span></div>
          </div>
          <div id="spin-log" class="muted-sm" style="margin-top:8px"></div>
        </div>
      </template>

      <template id="tpl-trivia">
        <div class="card">
          <div class="h1">Викторина «Угадай стиль»</div>
          <form id="trivia-form" class="g">
            <!-- вопросы будут подставлены JS -->
          </form>
          <div class="g g2" style="margin-top:8px">
            <button class="btn btn-primary" data-action="submit-trivia">Сдать</button>
            <button class="btn" data-action="reset-trivia">Сброс</button>
          </div>
          <div id="trivia-result" class="muted-sm" style="margin-top:8px"></div>
        </div>
      </template>

      <template id="tpl-ref">
        <div class="card">
          <div class="h1">Пригласи друзей</div>
          <p class="muted-sm">За друга — +100 коинов. За 3 друзей — мини‑дегустация.</p>
          <div class="g">
            <input id="ref-link" class="btn" readonly value="" />
            <div class="g g2">
              <button class="btn btn-primary" data-action="copy-ref">Скопировать</button>
              <button class="btn" data-action="share-ref">Поделиться</button>
            </div>
          </div>
        </div>
      </template>

      <template id="tpl-receipt">
        <div class="card">
          <div class="h1">Добавить визит (серия 3 за 30)</div>
          <div class="g g2">
            <input id="rcp-amount" class="btn" inputmode="decimal" placeholder="Сумма чека" />
            <button class="btn btn-primary" data-action="add-visit">Добавить</button>
          </div>
          <div style="margin-top:8px">
            <div class="muted-sm">Прогресс:</div>
            <div class="meter"><i id="visits-meter" style="width:0%"></i></div>
            <div class="muted-sm"><span id="visits-count">0</span>/3 в последние 30 дней</div>
          </div>
        </div>
      </template>

      <!-- ===== PAGES Страницы ===== -->
      <section class="page" id="home">
        <div class="hero">
          <img class="hero__media" src="beer_hero.jpg" alt="Beer Hero">
        </div>

        <div class="promo">
          <div class="promo__icon"><img src="ic_bonus.png" alt=""></div>
          <div>
            <div class="promo__title">Craft Beer</div>
            <div class="promo__sub">Кто мы, где мы</div>
          </div>
          <button class="promo__btn" data-open-intro
          aria-controls="intro"
          aria-label="Открыть онбординг">О нас</button>
        </div>

        <div class="card list-card tight">
          <div class="list-head">С чего начать</div>
          <div class="list">
            <div class="list__item">
              <div class="list__icon"><img src="ic_services.png" alt=""></div>
              <div class="list__text">
                <div class="list__title">Пивной Паспорт</div>
                <div class="list__sub">Собери 6 штампов — подарок</div>
              </div>
              <button class="list__chev-btn" data-open-sheet data-title="Пивной Паспорт" data-tpl="#tpl-passport">›</button>
            </div>
            <div class="list__item">
              <div class="list__icon"><img src="ic_bonus.png" alt=""></div>
              <div class="list__text">
                <div class="list__title">Ежедневный спин</div>
                <div class="list__sub">Кулдаун 24 ч, мелкие призы</div>
              </div>
              <button class="list__chev-btn" data-open-sheet data-title="Колесо Пива" data-tpl="#tpl-spin">›</button>
            </div>
            <div class="list__item">
              <div class="list__icon"><img src="ic_about.png" alt=""></div>
              <div class="list__text">
                <div class="list__title">Пригласи друзей</div>
                <div class="list__sub">+100 коинов за друга</div>
              </div>
              <button class="list__chev-btn" data-open-sheet data-title="Рефералы" data-tpl="#tpl-ref">›</button>
            </div>
          </div>
        </div>

        <!-- Games карточки ИГРЫ -->
<div class="card list-card games tight">
  <div class="list-head">Игры</div>
  <div class="list">
    <!-- Шмель -->
    <div class="list__item">
      <div class="list__icon"><img src="bumblebee.png" alt=""></div>
      <div class="list__text">
        <div class="list__title">Bumblebee</div>
        <div class="list__sub">Долети до нас и получи приз</div>
      </div>
<!-- Кнопка запуска на главной -->
<button class="list__btn list__btn--primary" data-open-flappy>Играть</button>
    </div>

    <!-- Гонки -->
    <div class="list__item">
      <div class="list__icon"><img src="racing.png" alt=""></div>
      <div class="list__text">
        <div class="list__title">Night Racing</div>
        <div class="list__sub">Катайся и прокачивай тачку</div>
      </div>
<!-- Кнопка запуска на главной -->
<button class="list__btn list__btn--primary" data-open-runner>Cкоро</button>
    </div>

    <!-- Бонусы -->
    <div class="list__item">
      <div class="list__icon"><img src="beercard.png" alt=""></div>
      <div class="list__text">
        <div class="list__title">Memory cards</div>
        <div class="list__sub">Найди все спрятанные карточки быстрее</div>
      </div>
<!-- Кнопка запуска на главной -->
<button class="list__btn list__btn--primary" data-open-runner>Скоро</button>

      </div>
</div>
      </section>

<!-- Турниры страница -->
<section id="leaderboard" class="page" style="display:none">
    <div class="promo">
    <div class="promo__icon">
      <img src="ic_about.png" alt="">
    </div>
    <div>
      <div class="promo__title">Halloween Clicker</div>
      <div class="promo__sub">Play</div>
    </div>
<button class="promo__btn" data-open-clicker>Clicker</button>
  </div>


  <div class="card lb-card inner">
    <div class="lb-head">
      <div>
        <div class="lb-title">Leaderboard</div>
        <div class="lb-sub">Clicker · daily & all-time</div>
      </div>
      <div class="lb-seg" role="tablist" aria-label="Leaderboard period">
        <button type="button" class="js-lb-mode" data-mode="daily" aria-pressed="true">Daily</button>
        <button type="button" class="js-lb-mode" data-mode="all">All-time</button>
      </div>
    </div>

    <!-- Ты -->
    <div class="lb-you" id="lb-you">
      <div class="lb-you__avatar" id="lb-you-ava">YOU</div>
      <div class="lb-you__meta">
        <div class="lb-you__name" id="lb-you-name">You</div>
        <div class="lb-sub" id="lb-you-note">best score</div>
      </div>
      <div class="lb-you__score" id="lb-you-score">0</div>
    </div>

    <!-- Топ -->
    <div class="lb-list" id="lb-list">
      <!-- сюда JS рендерит строки -->
    </div>

    <div class="lb-actions">
      <button class="lb-btn" id="lb-refresh" type="button">Refresh</button>
      <button class="lb-btn lb-btn--primary" type="button"
              data-open-clicker data-cooldown-hours="24" data-clicker-key="pumpkin">Play</button>
    </div>
  </div>
</section>

      <section class="page" id="games">
        <div class="card page-title">
          <div class="h1">Игры</div>
          <div class="g g2">
            <button class="btn btn-primary" data-open-sheet data-title="Cap Toss" data-tpl="#tpl-cap-toss">Cap Toss</button>
            <button class="btn" data-open-sheet data-title="Колесо Пива" data-tpl="#tpl-spin">Колесо Пива</button>
          </div>
        </div>
      </section>

<!-- BONUSES -->
  <section class="page" id="bonuses">
    <div class="card page-title">
      <h2 class="h1">Бонусы</h2>
      <p class="muted-sm">Крути колесо и забирай выпавший подарок.</p>
    </div>

    <div class="card bonus-card">
      <div class="h2"></div>

      <!-- ВЕРХ: только плашка-подсказка -->
      <div class="bonus-head">
        <div id="pickedPill" class="picked-pill muted">Нажми «Крутануть»</div>
      </div>

      <!-- КОЛЕСО -->
      <div id="bonusWheel" class="bonus-wheel" aria-live="polite">
        <div class="wheel-track" id="wheelTrack">
          <button class="bonus" data-name="Кружка"><img src="bonus1.png" alt="Кружка"><span>Кружка</span></button>
          <button class="bonus" data-name="Футболка"><img src="bonus2.png" alt="Футболка"><span>Футболка</span></button>
          <button class="bonus" data-name="Фисташки"><img src="bonus3.png" alt="Фисташки"><span>Фисташки</span></button>
          <button class="bonus" data-name="Скидка"><img src="bonus4.png" alt="Скидка"><span>Скидка</span></button>
          <button class="bonus" data-name="Дегустация"><img src="bonus5.png" alt="Дегустация"><span>Дегустация</span></button>
          <button class="bonus" data-name="Монеты"><img src="bonus6.png"
              alt="Монеты"><span>Монеты</span></button>
        </div>
        <div class="wheel-center"></div>
      </div>

      <!-- НИЗ: две кнопки в ряд -->
      <div class="actions">
        <button class="btn btn-primary" id="spinBtn">Крутануть</button>
        <button class="btn btn-primary" id="claimBtn" disabled>Забрать</button>
      </div>
    </div>
      </section>

      <section class="page" id="profile">
        <div class="card page-title">
          <div class="h1">Профиль</div>
          <div class="g">
            <div class="card">
              <div class="g g2">
                <div>
                  <div class="muted-sm">Пользователь</div>
                  <div id="user-name" class="h1">—</div>
                </div>
                <div style="text-align:right">
                  <div class="muted-sm">Коины</div>
                  <div class="h1" id="coins-profile">0</div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="muted-sm">Последние призы</div>
              <div id="rewards-feed">Пока пусто</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  (function app(){
    const TG = window.Telegram && window.Telegram.WebApp;
    if (TG){
      try{ TG.ready(); TG.expand(); TG.disableVerticalSwipes?.(); TG.enableClosingConfirmation?.(); TG.onEvent?.('viewportChanged', () => TG.disableVerticalSwipes?.()); }catch(e){ console.warn('TG init error', e); }
    }

    const ROOT = 'home';
    const sheetRoot = document.getElementById('sheet');
    const sheetPanel= sheetRoot?.querySelector('.sheet__panel');
    const sheetBody = document.getElementById('sheet-body');
    const sheetTitle= sheetRoot?.querySelector('.sheet__title');

    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const isInDOM = id => !!document.getElementById(id);

    function currentId(){
      const url = new URL(location.href);
      const qp = (url.searchParams.get('page') || '').trim();
      if (qp && isInDOM(qp)) return qp;
      const h = (location.hash || '#'+ROOT).replace(/^#/, '');
      return isInDOM(h) ? h : ROOT;
    }
    function setActivePage(id){
      qsa('main > section, section.page').forEach(s => {
        const on = (s.id === id);
        s.classList.toggle('active', on);
        s.style.display = on ? 'block' : 'none';
      });
      qsa('[data-page]').forEach(t => t.classList.toggle('active', t.dataset.page === id));
      requestAnimationFrame(()=> window.scrollTo({ top: 0, behavior:'auto' }));
      syncBack();
    }
    function navigateTo(id){
      if (!id || !isInDOM(id)) return;
      const h = '#'+id;
      if (h !== (location.hash || '#'+ROOT)){ history.pushState({id}, '', h); }
      setActivePage(id);
    }

    function showBack(){ try{ TG?.BackButton?.show && TG.BackButton.show(); }catch(_){ } }
    function hideBack(){ try{ TG?.BackButton?.hide && TG.BackButton.hide(); }catch(_){ } }
    function syncBack(){
      if (!TG) return;
      const atRoot = (currentId() === ROOT);
      const sheetOpen = sheetRoot?.classList.contains('is-open');
      if (sheetOpen || !atRoot) showBack(); else hideBack();
    }

    TG?.BackButton?.onClick?.(()=>{ if (sheetRoot && sheetRoot.classList.contains('is-open')){ closeSheet(); return; } const atRoot = (currentId() === ROOT); if (!atRoot) history.back(); });
    TG?.onEvent?.('backButtonClicked', ()=>{ if (sheetRoot && sheetRoot.classList.contains('is-open')){ closeSheet(); return; } const atRoot = (currentId() === ROOT); if (!atRoot) history.back(); });
    window.addEventListener('popstate', ()=> setActivePage(currentId()));

    function haptic(level='light'){ try{ TG?.HapticFeedback?.impactOccurred && TG.HapticFeedback.impactOccurred(level); } catch(_){ try{ navigator.vibrate && navigator.vibrate(level==='light'?10:16); }catch(_){} } }
    function openSheet({title='', html='', from='bottom'} = {}){
      if (!sheetRoot) return;
      sheetRoot.classList.toggle('sheet-bottom', from==='bottom');
      if (sheetTitle) sheetTitle.textContent = title || '';
      if (sheetBody && html != null) sheetBody.innerHTML = html;
      sheetRoot.classList.add('is-open'); document.body.classList.add('sheet-open');
      requestAnimationFrame(()=> sheetPanel?.focus({preventScroll:true}));
      haptic('light'); syncBack();
    }
    function closeSheet(){ if (!sheetRoot) return; sheetRoot.classList.remove('is-open'); document.body.classList.remove('sheet-open'); haptic('light'); syncBack(); }
    window.openSheet = openSheet; window.closeSheet = closeSheet;
    sheetRoot?.addEventListener('click', (e)=>{ if (e.target.closest('[data-close-sheet]')) closeSheet(); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && sheetRoot?.classList.contains('is-open')) closeSheet(); });

    // Prevent iOS pull-to-refresh when no TG.disableVerticalSwipes
    const isiOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    if (isiOS && !(TG && typeof TG.disableVerticalSwipes === 'function')){
      let startY = 0; document.addEventListener('touchstart', e => { startY = e.touches[0].clientY; }, {passive:true});
      document.addEventListener('touchmove', e => { const dy = e.touches[0].clientY - startY; const atTop = (window.scrollY <= 0); if (dy > 0 && atTop){ e.preventDefault(); } }, {passive:false});
    }

    // ===== Confetti (simple) =====
    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    function resizeCanvas(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    function confettiBurst(n=140, duration=900){
      const parts = Array.from({length:n},()=>({
        x: Math.random()*confettiCanvas.width,
        y: -10,
        vx: (Math.random()-0.5)*4,
        vy: Math.random()*3+2,
        r: Math.random()*3+1,
        a: 1
      }));
      const t0 = performance.now();
      function frame(t){
        const dt = (t - (confettiBurst._lt||t))/16; confettiBurst._lt = t;
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        parts.forEach(p=>{ p.x+=p.vx*dt; p.y+=p.vy*dt; p.a -= 0.01*dt; ctx.globalAlpha = Math.max(0,p.a); ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle = ['#f9b24d','#f29117','#ffd59c','#fff'][p.r|0 % 4]; ctx.fill(); });
        if (t - t0 < duration){ requestAnimationFrame(frame); } else { ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); }
      }
      requestAnimationFrame(frame);
    }

    // ===== App State & Storage =====
    const APP = {
      BOT_USERNAME: 'your_bot_username', // TODO: замените на @имя_бота
      WORKER_BASE: 'https://your-worker.example.dev/', // TODO: замените на ваш Worker
      API_KEY: 'dev-123',
      COOLDOWN_SPIN_HOURS: 24,
      MAX_TRIVIA: 5,
    };
    const store = {
      get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch(_){ return def }},
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
      now(){ return Date.now(); }
    };
    const SKEY = {
      coins: 'beer_coins',
      spinAt: 'beer_spin_next',
      rewards: 'beer_rewards',
      passport: 'beer_passport',
      visits: 'beer_visits',
      trivia: 'beer_trivia',
    };
    function addCoins(n){ const c = Math.max(0, (store.get(SKEY.coins,0) + n)|0); store.set(SKEY.coins,c); syncCoins(); }
    function coins(){ return store.get(SKEY.coins,0)|0; }

    function syncCoins(){
      qsa('#coins,#coins-inline,#coins-profile').forEach(el=> el && (el.textContent = coins()));
      const lvl = levelFromCoins(coins());
      const pct = Math.min(100, (coins() % 1000)/10);
      const lvlEl = document.getElementById('level'); if (lvlEl) lvlEl.textContent = lvl;
      const lm = document.getElementById('lvl-meter'); if (lm) lm.style.width = pct+'%';
      const cm = document.getElementById('coin-meter'); if (cm) cm.style.width = Math.min(100, coins()/10)+'%';
    }
    function levelFromCoins(c){ if (c >= 3000) return 'Gold'; if (c >= 1500) return 'Silver'; return 'Bronze'; }

    // ===== Pages: Home interactions =====
    document.addEventListener('click', (e)=>{
      const openBtn = e.target.closest('[data-open-sheet]');
      if (openBtn){ e.preventDefault(); const tplSel = openBtn.dataset.tpl || ''; const tpl = tplSel ? document.querySelector(tplSel) : null; const html = tpl ? tpl.innerHTML : ''; const ttl = openBtn.getAttribute('title') || openBtn.dataset.title || openBtn.textContent.trim() || ''; const from = openBtn.dataset.from || 'bottom'; openSheet({ title: ttl, html, from }); initSheet(ttl); return; }
      const tab = e.target.closest('[data-page]'); if (tab){ e.preventDefault(); navigateTo(tab.dataset.page); }

      // sheet actions
      const act = e.target.closest('[data-action]')?.dataset.action;
      if (!act) return;
      switch(act){
        case 'start-cap': startCapToss(); break;
        case 'cap-help': alert('Свайпай, чтобы бросать. Комбо и «Foam Frenzy» позже прикрутим.'); break;
        case 'spin': handleSpin(); break;
        case 'add-stamp': addStampPrompt(); break;
        case 'reset-passport': resetPassport(); break;
        case 'submit-trivia': submitTrivia(); break;
        case 'reset-trivia': resetTrivia(); break;
        case 'copy-ref': copyRef(); break;
        case 'share-ref': shareRef(); break;
        case 'add-visit': addVisit(); break;
      }
    });

    // ===== Router bootstrap =====
    const start = currentId(); history.replaceState({id:start}, '', '#'+start); setActivePage(start);
    setTimeout(()=>{ TG?.disableVerticalSwipes?.(); syncBack(); }, 0);
    setTimeout(()=>{ TG?.disableVerticalSwipes?.(); syncBack(); }, 300);

    // ===== User name in profile =====
    (function fillUser(){
      const u = TG?.initDataUnsafe?.user; const name = u ? (u.first_name + (u.last_name? (' ' + u.last_name) : '')) : 'Гость';
      const nameEl = document.getElementById('user-name'); if (nameEl) nameEl.textContent = name;
    })();

    // ===== Sheet initializers =====
    function initSheet(title){
      if (/паспорт/i.test(title)) renderPassport();
      if (/колесо/i.test(title)) initSpin();
      if (/реферал|друз/i.test(title)) initRef();
      if (/викторин/i.test(title)) renderTrivia();
      if (/визит/i.test(title)) renderVisits();
      if (/cap toss/i.test(title)) initCapUI();
      syncCoins();
    }

    // ===== Spin logic =====
    const PRIZES = [
      {code:'nuts', title:'Орешки', coins:50, weight:25},
      {code:'-5',   title:'Купон -5%', coins:80, weight:20},
      {code:'sticker', title:'Стикер', coins:40, weight:22},
      {code:'x2',   title:'x2 коины за следующий чек (48ч)', coins:0, weight:14},
      {code:'-10',  title:'Купон -10% (48ч)', coins:120, weight:10},
      {code:'rare', title:'Редкая банка (чеком подтвердить)', coins:200, weight:9},
    ];
    function rollPrize(){
      const total = PRIZES.reduce((s,p)=>s+p.weight,0); let r = Math.random()*total; for(const p of PRIZES){ if((r-=p.weight)<=0) return p; } return PRIZES[0];
    }
    function initSpin(){
      const next = store.get(SKEY.spinAt,0);
      const el = document.getElementById('spin-state');
      updateSpinState(el, next);
    }
    function updateSpinState(el, next){
      const now = store.now();
      if (now >= next){ el.textContent = 'Готово к вращению'; } else {
        const left = Math.max(0, next - now); const h = Math.floor(left/3600000); const m = Math.floor((left%3600000)/60000);
        el.textContent = `Кулдаун: ${h}ч ${m}м`;
      }
    }
    function handleSpin(){
      const el = document.getElementById('spin-state'); const next = store.get(SKEY.spinAt,0); const now = store.now();
      if (now < next){ haptic('light'); alert(el?.textContent || 'Кулдаун'); return; }
      const prize = rollPrize();
      addCoins(prize.coins);
      logReward({source:'spin', prize:prize.title});
      confettiBurst(160, 1100); haptic('light');
      document.getElementById('spin-log')?.insertAdjacentHTML('afterbegin', `<div>🎉 Вы выиграли: <b>${prize.title}</b> (+${prize.coins}🪙)</div>`);
      const newNext = now + APP.COOLDOWN_SPIN_HOURS*3600000;
      store.set(SKEY.spinAt, newNext);
      updateSpinState(el, newNext);
    }

    // ===== Rewards feed =====
    function logReward(rec){ const r = store.get(SKEY.rewards,[]); r.unshift({ts:Date.now(),...rec}); store.set(SKEY.rewards,r); renderRewards(); }
    function renderRewards(){
      const r = store.get(SKEY.rewards,[]); const box = document.getElementById('rewards-feed'); if (!box) return;
      if (!r.length){ box.textContent='Пока пусто'; return; }
      box.innerHTML = r.slice(0,8).map(x=>`<div>• ${new Date(x.ts).toLocaleString()} — ${x.source}: <b>${x.prize}</b></div>`).join('');
    }

    // ===== Passport =====
    const STYLES = ['Lager','IPA','Stout','Weizen','Sour','Cider'];
    function renderPassport(){
      const data = store.get(SKEY.passport, {});
      const grid = document.getElementById('passport-grid'); if (!grid) return;
      grid.innerHTML = STYLES.map(s=>{
        const c = data[s]||0; const done = c>0 ? 'badge badge--green' : 'badge';
        return `<div class="card" style="text-align:center"><div style="font-weight:800">${s}</div><div class="${done}" style="margin-top:6px">${c>0?'Штамп есть':'Нет штампа'}</div></div>`;
      }).join('');
    }
    function addStampPrompt(){
      const style = prompt('Какой стиль? (Lager, IPA, Stout, Weizen, Sour, Cider)'); if (!style) return;
      const S = style.trim(); if (!STYLES.includes(S)) return alert('Неизвестный стиль');
      const pin = prompt('PIN сотрудника (демо: 1111)'); if (pin !== '1111') return alert('PIN неверный');
      const data = store.get(SKEY.passport, {}); data[S] = 1; store.set(SKEY.passport, data); renderPassport(); addCoins(100); confettiBurst(); logReward({source:'passport', prize:'Штамп '+S});
    }
    function resetPassport(){ store.set(SKEY.passport, {}); renderPassport(); }

    // ===== Trivia =====
    const TRIVIA = [
      {q:'Какой стиль обычно мутный и бананово‑гвоздичный?', a:['Lager','Weizen','Stout'], ok:1},
      {q:'IBU — это…', a:['Горечь','Плотность','Цвет'], ok:0},
      {q:'Что чаще даёт тропики?', a:['Американский хмель','Лагерные дрожжи','Солод Pilsner'], ok:0},
      {q:'Stout ассоциируют с нотами…', a:['Кофе/шоколад','Лайм','Зелёное яблоко'], ok:0},
      {q:'Sour — это…', a:['Кислое','Супергорькое','Дымное'], ok:0},
    ];
    function renderTrivia(){
      const f = document.getElementById('trivia-form'); if (!f) return;
      f.innerHTML = TRIVIA.slice(0,APP.MAX_TRIVIA).map((t,i)=>{
        return `<div class="card"><div style="font-weight:700">${i+1}. ${t.q}</div>${t.a.map((opt,idx)=>`<label style="display:block; margin-top:6px"><input type="radio" name="q${i}" value="${idx}"> ${opt}</label>`).join('')}</div>`;
      }).join('');
    }
    function submitTrivia(){
      let score=0; for(let i=0;i<APP.MAX_TRIVIA;i++){ const v = (new FormData(document.getElementById('trivia-form'))).get('q'+i); if (v!=null && +v===TRIVIA[i].ok) score++; }
      const res = document.getElementById('trivia-result'); res.textContent = `Верных ответов: ${score}/${APP.MAX_TRIVIA}`;
      if (score>=4){ addCoins(120); logReward({source:'trivia', prize:'Купон -10% (48ч)'}); confettiBurst(); haptic('light'); }
    }
    function resetTrivia(){ renderTrivia(); document.getElementById('trivia-result').textContent=''; }

    // ===== Referrals =====
    function initRef(){
      const u = TG?.initDataUnsafe?.user; const uid = u?.id || Math.floor(Math.random()*1e9);
      const code = 'beer_ref_'+uid;
      const link = `https://t.me/${APP.BOT_USERNAME}?start=${code}`;
      const input = document.getElementById('ref-link'); if (input) input.value = link;
    }
    async function copyRef(){ const el = document.getElementById('ref-link'); if(!el) return; el.select(); document.execCommand?.('copy'); try{ await navigator.clipboard.writeText(el.value); }catch{} haptic('light'); }
    async function shareRef(){ const el = document.getElementById('ref-link'); if(!el) return; const txt = 'Залетай в пивной мини‑апп и забери приз! '+el.value; try{ await navigator.share?.({text:txt}); }catch{ try{ await navigator.clipboard.writeText(el.value);}catch{} } haptic('light'); }

    // ===== Visits (3 in 30 days) =====
    function renderVisits(){
      const list = store.get(SKEY.visits,[]).filter(x=> Date.now()-x.ts < 30*24*3600000);
      const cnt = list.length; const pct = Math.min(100, cnt/3*100);
      const m = document.getElementById('visits-meter'); if (m) m.style.width = pct+'%';
      const c = document.getElementById('visits-count'); if (c) c.textContent = cnt;
    }
    function addVisit(){
      const v = store.get(SKEY.visits,[]); const amt = parseFloat(document.getElementById('rcp-amount').value||'0')||0; v.push({ts:Date.now(), amount:amt}); store.set(SKEY.visits,v); renderVisits(); addCoins(80); logReward({source:'visit', prize:'Шаг серии 3 за 30'}); if (v.filter(x=> Date.now()-x.ts < 30*24*3600000).length>=3){ logReward({source:'series', prize:'Спин «Колеса Пива»'}); confettiBurst(200,1200); }
    }

    // ===== Cap Toss (canvas visual demo with cups) =====
    let cap = {on:false, shots:0, score:0, t0:0, dur:30000, max:15};
    let capVis = null; // визуальное состояние (canvas)

    function initCapUI(){
      const sEl = document.getElementById('cap-score'); if (sEl) sEl.textContent='0';
      const shEl = document.getElementById('cap-shots'); if (shEl) shEl.textContent='0/'+cap.max;
      const tEl = document.getElementById('cap-time'); if (tEl) tEl.textContent='00:30';

      const canvas = document.getElementById('cap-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      function resize(){
        const r = canvas.getBoundingClientRect();
        canvas.width = Math.max(320, Math.floor(r.width*devicePixelRatio));
        canvas.height= Math.max(200, Math.floor(r.height*devicePixelRatio));
      }
      resize();

      // три «кружки» (таргеты)
      const W = ()=>canvas.width, H = ()=>canvas.height;
      const cups = [
        {x:()=>W()*0.25, y:()=>H()*0.22, r:()=>28*devicePixelRatio, pts:100, color:'#f9b24d', name:'Lager'},
        {x:()=>W()*0.50, y:()=>H()*0.18, r:()=>28*devicePixelRatio, pts:150, color:'#ffd59c', name:'IPA'},
        {x:()=>W()*0.75, y:()=>H()*0.22, r:()=>28*devicePixelRatio, pts:200, color:'#f29117', name:'Stout'},
      ];

      capVis = { canvas, ctx, cups, proj:null, lastT:0, animId:0, resize };

      // первичный рендер
      drawCapScene();
      window.addEventListener('resize', ()=>{ resize(); drawCapScene(); }, {passive:true});
    }

    function drawCapScene(){
      if (!capVis) return;
      const {canvas, ctx, cups, proj} = capVis;
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      // фон
      const grd = ctx.createLinearGradient(0,0,0,H);
      grd.addColorStop(0,'rgba(255,255,255,0.06)');
      grd.addColorStop(1,'rgba(255,255,255,0.00)');
      ctx.fillStyle = grd; ctx.fillRect(0,0,W,H);

      // чашки/мишени
      cups.forEach((c,i)=>{
        ctx.beginPath(); ctx.arc(c.x(), c.y(), c.r(), 0, Math.PI*2);
        ctx.fillStyle = c.color; ctx.globalAlpha = 0.18; ctx.fill();
        ctx.globalAlpha = 1; ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(255,255,255,.35)'; ctx.stroke();
        ctx.font = `${12*devicePixelRatio}px Inter`; ctx.textAlign='center'; ctx.fillStyle = 'rgba(255,255,255,.85)';
        ctx.fillText(c.name, c.x(), c.y() - (c.r()+8*devicePixelRatio));
        ctx.fillText('+'+c.pts, c.x(), c.y() + (c.r()+14*devicePixelRatio));
      });

      // projectile (крышка)
      if (proj){
        ctx.beginPath(); ctx.arc(proj.x, proj.y, 10*devicePixelRatio, 0, Math.PI*2);
        ctx.fillStyle = '#fff'; ctx.shadowColor='rgba(255,255,255,.6)'; ctx.shadowBlur=8*devicePixelRatio; ctx.fill(); ctx.shadowBlur=0;
      }
    }

    function startCapToss(){
      cap = {on:true, shots:0, score:0, t0:Date.now(), dur:30000, max:15};
      updateCapTime(); syncCapHUD();
      const area = document.getElementById('cap-area'); if(!area) return;

      // сброс слушателей и скрытие подсказки
      const clone = area.cloneNode(true); area.parentNode.replaceChild(clone, area);
      const box = document.getElementById('cap-area');
      box.querySelector('.cap-msg')?.remove();

      // Убедимся, что канвас проинициализирован
      initCapUI();

      let down = null;
      const onDown = (e)=>{ down = {x:e.clientX, y:e.clientY, t:performance.now()}; };
      const onUp = (e)=>{ if (!cap.on) return; throwCap(down, {x:e.clientX, y:e.clientY, t:performance.now()}); };

      ['pointerdown','touchstart','mousedown'].forEach(ev=> box.addEventListener(ev, onDown, {passive:true}));
      ['pointerup','touchend','mouseup','click'].forEach(ev=> box.addEventListener(ev, onUp, {passive:true}));

      setTimeout(finishCap, cap.dur+120);
    }

    function throwCap(start, end){
      if (cap.shots>=cap.max) return;
      cap.shots++;

      // Начальная позиция — нижний центр
      const {canvas} = capVis; const W = canvas.width, H = canvas.height;
      const sx = W*0.5, sy = H*0.86;

      // Скорость из жеста, fallback — фиксированный вектор вверх
      const dx = (end?.x||0) - (start?.x||0);
      const dy = (end?.y||0) - (start?.y||0);
      const dt = Math.max(1, (end?.t||0) - (start?.t||0));
      const speed = Math.min(1.8, Math.hypot(dx,dy)/Math.max(60,dt));
      const ang = Math.atan2(-Math.abs(dy)||-1, dx||0) || -1.2; // угол полёта (вверх)

      const v0 = (260 + Math.random()*90) * devicePixelRatio * (0.6 + 0.4*speed);
      const vx = v0 * Math.cos(ang) * 0.016; // px per frame
      const vy = v0 * Math.sin(ang) * 0.016;
      const g  = 9.8 * devicePixelRatio * 0.12; // gravity per frame

      capVis.proj = {x:sx, y:sy, vx, vy, g};
      haptic('light');
      animateProjectile();
    }

    function animateProjectile(){
      if (!capVis?.proj) return;
      const {canvas, cups} = capVis;
      const p = capVis.proj;
      const step = ()=>{
        if (!cap.on) return; // игра завершена
        // update
        p.x += p.vx; p.y += p.vy; p.vy += p.g;
        // collide with cups
        for(const c of cups){
          const dx = p.x - c.x(); const dy = p.y - c.y(); const hit = Math.hypot(dx,dy) <= c.r()+10*devicePixelRatio;
          if (hit){
            cap.score += c.pts;
            confettiBurst(80,700); haptic('light');
            capVis.proj = null; // остановить
            syncCapHUD();
            drawCapScene();
            return; // бросок завершён
          }
        }
        // out of bounds
        if (p.y < 0 || p.x< -20*devicePixelRatio || p.x > canvas.width+20*devicePixelRatio || p.y > canvas.height+10*devicePixelRatio){
          capVis.proj = null; drawCapScene(); return;
        }
        drawCapScene();
        capVis.animId = requestAnimationFrame(step);
      };
      cancelAnimationFrame(capVis.animId); capVis.animId = requestAnimationFrame(step);
    }

    function syncCapHUD(){
      const sh = document.getElementById('cap-shots'); if (sh) sh.textContent = cap.shots+'/'+cap.max;
      const sc = document.getElementById('cap-score'); if (sc) sc.textContent = cap.score;
    }
    function updateCapTime(){
      if(!cap.on) return;
      const left = Math.max(0, cap.dur - (Date.now()-cap.t0));
      const s = Math.ceil(left/1000); const mm = String(Math.floor(s/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0');
      const el = document.getElementById('cap-time'); if (el) el.textContent = mm+':'+ss;
      if (left>0) requestAnimationFrame(updateCapTime);
    }
    function finishCap(){
      if(!cap.on) return; cap.on=false; capVis && cancelAnimationFrame(capVis.animId);
      const bonus = Math.floor(cap.score/10);
      addCoins(bonus);
      logReward({source:'cap_toss', prize:`Очки ${cap.score} → +${bonus}🪙`});
      confettiBurst(180,1200); haptic('light');
    }

    // ===== Init state =====
    syncCoins(); renderRewards();
  })();
  </script>

  <script>
(function introSlider(){
  const TG = window.Telegram && window.Telegram.WebApp;

  // ====== КОНФИГ КНОПОК ПО СЛАЙДАМ ======
  // Индексы соответствуют порядку секций .intro__slide в #intro-slides
  const INTRO_CFG = {
    actions: {
      0: [ // Слайд 1 — две рядом
        { label:'Нет', type:'ghost', do:'navigate', value:'no' },
        { label:'Да',  type:'primary', do:'answer', to:'next' } // перейти в раздел "Запись"
      ],
      1: [ // Слайд 0 — одна кнопка
        { label:'Продолжить', type:'primary', do:'next' }
      ],
      2: [ // Слайд 2 — одна кнопка
        { label:'Продолжить', type:'primary', do:'next' }
      ],
      3: [ // Слайд 3 — одна кнопка
        { label:'Играть', type:'ghost', do:'navigate' }
      ]
      // Примеры для будущих слайдов:
      // 3: [
      //   { label:'Открыть сайт', type:'primary', do:'link', href:'https://example.com' }
      // ],
      // 4: [
      //   { label:'Показать окно', type:'primary', do:'sheet', title:'Демо', tpl:'#tpl-example', from:'bottom' }
      // ]
    },
    onAnswer: (index, value) => {
      // Твой хук на ответы "Да/Нет" и т.п.
      // Например: localStorage.setItem('intro_answer_'+index, value);
      // console.log('Answer on slide', index, '=>', value);
    }
  };

  // ====== DOM ======
  const root = document.getElementById('intro');
  if(!root) return;

  const slidesWrap = root.querySelector('#intro-slides');
  const slides = Array.from(root.querySelectorAll('.intro__slide'));
  const progress = root.querySelector('#intro-progress');
  const actions = root.querySelector('#intro-actions');

  // Прогресс
  progress.innerHTML = slides.map(()=>'<i class="intro__seg"></i>').join('');
  const segs = Array.from(progress.children);

  let idx = 0, touchX0=0, touchX=0, dragging=false, backHandler=null;

  const haptic = (lvl='light') => { try{ TG?.HapticFeedback?.impactOccurred(lvl); }catch(_){ } };

  // Сервис: создать кнопку
  function btnHTML(cfg){
    const cls = ['intro__btn'];
    if (cfg.type === 'primary') cls.push('intro__btn--primary');
    if (cfg.type === 'ghost')   cls.push('intro__btn--ghost');
    const attrs = [];
    if (cfg.do) attrs.push(`data-act="${cfg.do}"`);
    if (cfg.value != null) attrs.push(`data-val="${String(cfg.value)}"`);
    if (cfg.to)    attrs.push(`data-to="${String(cfg.to)}"`);
    if (cfg.href)  attrs.push(`data-href="${String(cfg.href)}"`);
    if (cfg.title) attrs.push(`data-title="${String(cfg.title)}"`);
    if (cfg.tpl)   attrs.push(`data-tpl="${String(cfg.tpl)}"`);
    if (cfg.from)  attrs.push(`data-from="${String(cfg.from)}"`);
    return `<button class="${cls.join(' ')}" ${attrs.join(' ')}>${cfg.label}</button>`;
  }

  // Рендер низа (кнопок)
  function renderActions(){
    const set = INTRO_CFG.actions[idx] || defaultActions();
    // сетка: 1 / 2 / 3+
    actions.className = 'intro__actions';
    if (set.length === 1) actions.classList.add('intro__actions--one');
    else if (set.length === 2) actions.classList.add('intro__actions--two');
    else actions.classList.add('intro__actions--multi'); // см. CSS ниже
    actions.innerHTML = set.map(btnHTML).join('');
  }

  // Дефолт, если не задал для слайда: "Продолжить" или "Готово" на последнем
  function defaultActions(){
    const last = (idx === slides.length - 1);
    return [ { label: last ? 'Готово' : 'Продолжить', type:'primary', do: last ? 'done' : 'next' } ];
    // можно заменить на то, что тебе нужно по умолчанию
  }

  function apply(){
    slides.forEach((s,i)=> s.classList.toggle('active', i===idx));
    segs.forEach((d,i)=> d.classList.toggle('active', i<=idx));
    renderActions();
  }

  // Открыть / закрыть
  function openIntro(startIndex){
    if (Number.isInteger(startIndex)) idx = Math.max(0, Math.min(startIndex, slides.length-1));
    root.classList.add('is-open');
    document.body.classList.add('intro-open');

    try{
      TG?.BackButton?.show?.();
      backHandler = ()=> closeIntro();
      TG?.BackButton?.onClick?.(backHandler);
      TG?.disableVerticalSwipes?.();
    }catch(_){}

    apply();
    window.syncBack?.();
  }
  function closeIntro(){
    root.classList.remove('is-open');
    document.body.classList.remove('intro-open');

    try{ TG?.BackButton?.offClick?.(backHandler); backHandler=null; }catch(_){}
    if (typeof window.syncBack === 'function') window.syncBack(); else try{ TG?.BackButton?.hide?.(); }catch(_){}
  }

  function next(){ if(idx<slides.length-1){ idx++; apply(); haptic(); } }
  function prev(){ if(idx>0){ idx--; apply(); haptic(); } }

  // Жесты перелистывания
  slidesWrap.addEventListener('touchstart', e=>{ dragging=true; touchX0=touchX=e.touches[0].clientX; }, {passive:true});
  slidesWrap.addEventListener('touchmove',  e=>{ if(!dragging) return; touchX=e.touches[0].clientX; }, {passive:true});
  slidesWrap.addEventListener('touchend',   ()=>{ if(!dragging) return; dragging=false;
    const dx = touchX - touchX0; if (Math.abs(dx)>50){ dx<0 ? next() : prev(); }
  });

  // Клики по кнопкам низа
  actions.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-act]'); if(!b) return;
    const act  = b.getAttribute('data-act');
    const val  = b.getAttribute('data-val');
    const to   = b.getAttribute('data-to');
    const href = b.getAttribute('data-href');
    const title= b.getAttribute('data-title');
    const tpl  = b.getAttribute('data-tpl');
    const from = b.getAttribute('data-from') || 'bottom';

    switch(act){
      case 'next': next(); break;
      case 'prev': prev(); break;
      case 'done': haptic('medium'); closeIntro(); break;
      case 'answer':
        try{ INTRO_CFG.onAnswer && INTRO_CFG.onAnswer(idx, val); }catch(_){}
        next(); break;
      case 'navigate':
        closeIntro();
        if (typeof window.navigateTo === 'function') window.navigateTo(to);
        else if (to) location.hash = '#'+to;
        break;
      case 'link':
        try{ TG?.openLink ? TG.openLink(href) : window.open(href, '_blank'); }catch(_){}
        break;
      case 'sheet':
        closeIntro();
        if (typeof window.openSheet === 'function'){
          const tplNode = tpl ? document.querySelector(tpl) : null;
          const html = tplNode ? tplNode.innerHTML : '<div class="card"><b>Нет шаблона</b></div>';
          window.openSheet({ title, html, from });
        }
        break;
    }
  });

  // Открывать по кнопке: data-open-intro или data-open-intro="2" (старт слайд 2)
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-open-intro]');
    if (!t) return;
    e.preventDefault();
    const start = parseInt(t.getAttribute('data-open-intro'), 10);
    openIntro(Number.isFinite(start) ? start : undefined);
  });

  // Экспорт (если захочешь открыть из кода)
  window.openIntro  = openIntro;
  window.closeIntro = closeIntro;
})();
</script>


<script>
/* ===== Flappy-lite+ — coins, shield, custom sprites, BackButton ШМЕЛЬ ===== */
(function flappyLitePlus(){
  const TG = window.Telegram && window.Telegram.WebApp;

  // DOM
  const root   = document.getElementById('flappy'); if (!root) return;
  const stage  = document.getElementById('fl-stage');
  const birdEl = document.getElementById('fl-bird');
  const hintEl = document.getElementById('fl-hint');
  const scoreEl= document.getElementById('fl-score');
  const barEl  = document.getElementById('fl-bar');

  const coinIco= document.getElementById('fl-coin-ico');
  const coinCnt= document.getElementById('fl-coin-count');
  const shIco  = document.getElementById('fl-shield-ico');
  const shBar  = document.getElementById('fl-shield-bar');

  const resBox = document.getElementById('fl-result');
  const bestEl = document.getElementById('fl-best');
  const worldEl= document.getElementById('fl-world');
  const cta    = document.getElementById('fl-cta');

  /* ===== ASSETS: поменяй пути/размеры под свои картинки ===== */
 // ЗАМЕНИ на свои картинки и размеры (CSS-пиксели, не обязаны совпадать с реальным размером PNG)
const ASSETS = {
  bird:   { img: 'bumblebee.png',  w: 56, h: 42 },        // птичка
  pipes:  {                                  // трубы: верх/низ (если одна картинка — укажи её в обоих)
    top:    'pipe_top.png',
    bottom: 'pipe_bottom.png',
    width:  54                                // ВАЖНО: видимая ширина трубы в px
  },
  coin:   { img: 'coin.png',   w: 32, h: 32, value: 5 },
  shield: { img: 'shield.png', w: 34, h: 34, dur_ms: 6000 }
};


  /* ===== TUNING ===== */
  const WORLD_RECORD     = 200;
  const GRAVITY          = 1800;      // px/s^2
  const FLAP_VELOCITY    = -520;      // px/s
  const SPEED_X          = 220;       // базовая скорость труб
  const ACCEL_EACH_MS    = 8000;      // автоускорение каждые N мс
  const SPEED_STEP       = 28;        // шаг ускорения
  const PIPE_SPAWN_MS    = 1300;      // частота спавна труб
  const GAP_MIN          = 150;       // мин. зазор
  const GAP_MAX          = 190;       // макс. зазор
  const GAP_TOP_PAD      = 80;        // отступ от краёв
  const BIRD_X_FACTOR    = 0.25;      // 25% ширины
  const ROT_UP           = -35, ROT_DOWN = 90;
  const SAFE_FLOOR_PAD   = 6;

  // items
  const COIN_IN_GAP_PROB = 0.9;      // шанс монетки в каждой щели
  const SHIELD_PROB      = 0.9;      // шанс щита (редкий)
  const SHIELD_COOLDOWN  = 9000;      // не чаще одного раз в N мс

  // === Magnet (coins attract to bird when shield is active) ===
const MAGNET_ENABLED   = true;  // можно выключить
const MAGNET_RADIUS    = 140;   // радиус захвата, px
const MAGNET_PULL_PX_S = 300;   // скорость притяжения, px/сек


  // STATE
  let best     = Number(localStorage.getItem('flappy_best')||0);
  let running  = false, started=false;
  let raf      = 0, spawnT=0, t0=0, backOff=null;
  let w=0,h=0, birdX=0, birdY=0, birdVY=0;

  let pipes=[];   // {x, gapY, gap, topEl, botEl, passed:false}
  let items=[];   // [{type:'coin'|'shield', x,y, el}]
  let lastShieldSpawn = 0;

  let score=0, coins=0;
  let shieldActive=false, shieldUntil=0;

  // helpers
  const haptic = lvl=>{ try{ TG?.HapticFeedback?.impactOccurred(lvl||'light'); }catch(_){} };
  const clamp  = (v,a,b)=> Math.max(a, Math.min(b, v));
  const rand   = (a,b)=> a + Math.random()*(b-a);

  // apply assets → css vars & backgrounds
  function applyAssets(){
    // bird
    document.documentElement.style.setProperty('--bird-w', (ASSETS.bird.w||48)+'px');
    document.documentElement.style.setProperty('--bird-h', (ASSETS.bird.h||36)+'px');
    if (ASSETS.bird.img){
      birdEl.classList.add('fl-bird--sprite');
      birdEl.style.backgroundImage = `url(${ASSETS.bird.img})`;
    } else {
      birdEl.classList.remove('fl-bird--sprite'); birdEl.style.backgroundImage = '';
    }
    // pipes
    document.documentElement.style.setProperty('--pipe-w', (ASSETS.pipes.width||76)+'px');
    // hud icons
    if (ASSETS.coin.img) coinIco.style.backgroundImage = `url(${ASSETS.coin.img})`;
    if (ASSETS.shield.img) shIco.style.backgroundImage = `url(${ASSETS.shield.img})`;
    document.documentElement.style.setProperty('--coin-w', (ASSETS.coin.w||32)+'px');
    document.documentElement.style.setProperty('--coin-h', (ASSETS.coin.h||32)+'px');
    document.documentElement.style.setProperty('--pow-w',  (ASSETS.shield.w||34)+'px');
    document.documentElement.style.setProperty('--pow-h',  (ASSETS.shield.h||34)+'px');
  }

  // layout
  function layout(){
    w = stage.clientWidth; h = stage.clientHeight;
    birdX = w * BIRD_X_FACTOR;
    if (!started){ birdY = h * 0.45; applyBird(); }
  }
  function applyBird(){
    birdEl.style.left = birdX + 'px';
    birdEl.style.top  = birdY + 'px';
  }
  function setScore(v){ scoreEl.textContent = v; }
  function setCoins(v){ coinCnt.textContent = v; }

  // pipes
  function spawnPipe(){
    const gap = rand(GAP_MIN, GAP_MAX);
    const minY = GAP_TOP_PAD + gap/2;
    const maxY = h - GAP_TOP_PAD - gap/2;
    const gapY = rand(minY, maxY);

    const top = document.createElement('div');
    const bot = document.createElement('div');
    top.className = 'fl-pipe-part';
    bot.className = 'fl-pipe-part';
    if (ASSETS.pipes.top && ASSETS.pipes.bottom){
      top.classList.add('fl-pipe--sprite'); bot.classList.add('fl-pipe--sprite');
      top.style.backgroundImage = `url(${ASSETS.pipes.top})`;
      bot.style.backgroundImage = `url(${ASSETS.pipes.bottom})`;
    }
    stage.appendChild(top); stage.appendChild(bot);

    const p = { x: w + (ASSETS.pipes.width||76), gapY, gap, topEl: top, botEl: bot, passed:false };
    pipes.push(p);
    positionPipe(p);

    // coin in gap?
    if (Math.random() < COIN_IN_GAP_PROB){
      const c = document.createElement('div');
      c.className = 'fl-coin';
      if (ASSETS.coin.img) c.style.backgroundImage = `url(${ASSETS.coin.img})`;
      stage.appendChild(c);
      items.push({ type:'coin', x: p.x + 200, y: gapY, el: c }); // чуть правее появления трубы
      positionItem(items[items.length-1]);
    }

    // occasional shield (with cooldown)
    if (Date.now() - lastShieldSpawn > SHIELD_COOLDOWN && Math.random() < SHIELD_PROB){
      const s = document.createElement('div');
      s.className = 'fl-power';
      if (ASSETS.shield.img) s.style.backgroundImage = `url(${ASSETS.shield.img})`;
      stage.appendChild(s);
      items.push({ type:'shield', x: p.x + 300, y: gapY - gap*0.35, el: s });
      positionItem(items[items.length-1]);
      lastShieldSpawn = Date.now();
    }
  }

  function positionPipe(p){
    const pipeW = (ASSETS.pipes.width||76);
    const th = p.gapY - p.gap/2;   // height of top pipe
    const bt = p.gapY + p.gap/2;   // top of bottom pipe
    p.topEl.style.left = p.x + 'px';
    p.topEl.style.top  = '0px';
    p.topEl.style.height = th + 'px';
    p.topEl.style.width  = pipeW + 'px';
    p.botEl.style.left = p.x + 'px';
    p.botEl.style.top  = bt + 'px';
    p.botEl.style.height = (h - bt) + 'px';
    p.botEl.style.width  = pipeW + 'px';
  }

  function positionItem(it){
    it.el.style.left = it.x + 'px';
    it.el.style.top  = it.y + 'px';
  }

  function removePipe(p){ p.topEl.remove(); p.botEl.remove(); }
  function removeItem(it){ it.el.remove(); }

  // collisions
  function rectsOverlap(a,b){
    return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom);
  }
  function collidePipe(){
    const br = birdEl.getBoundingClientRect();
    for (const p of pipes){
      if (rectsOverlap(br, p.topEl.getBoundingClientRect()) || rectsOverlap(br, p.botEl.getBoundingClientRect())){
        return true;
      }
    }
    return false;
  }
  function collideItems(){
    const br = birdEl.getBoundingClientRect();
    const dead=[];
    for (let i=0;i<items.length;i++){
      const it = items[i];
      const ir = it.el.getBoundingClientRect();
      if (rectsOverlap(br, ir)){
        if (it.type==='coin'){
          coins += 1; setCoins(coins);
          score += (ASSETS.coin.value||5); setScore(score);
          haptic('medium');
        } else if (it.type==='shield'){
          activateShield();
          haptic('medium');
        }
        removeItem(it); dead.push(i);
      }
    }
    for (let i=dead.length-1;i>=0;i--) items.splice(dead[i],1);
  }

  // shield
  function activateShield(){
    shieldActive = true;
    shieldUntil  = Date.now() + (ASSETS.shield.dur_ms||6000);
    birdEl.classList.add('fl-bird--shield');
  }
  function updateShieldHud(){
    if (!shieldActive){ shBar.style.transform = 'scaleX(0)'; return; }
    const left = shieldUntil - Date.now();
    if (left <= 0){
      shieldActive = false; birdEl.classList.remove('fl-bird--shield');
      shBar.style.transform = 'scaleX(0)';
    } else {
      const pct = clamp(left / (ASSETS.shield.dur_ms||6000), 0, 1);
      shBar.style.transform = `scaleX(${pct})`;
    }
  }

  // control
  function flap(){
    if (!running) return;
    if (!started){
      started = true;
      hintEl.style.display = 'none';
      birdVY = FLAP_VELOCITY;
    } else {
      birdVY = FLAP_VELOCITY;
    }
    haptic('light');
  }

  // loop
  function tick(){
    const now = performance.now();
    const dt  = Math.min(32, now - (tick._prev||now)); tick._prev = now;

    // progress bar (просто «бежит»)
    const elapsed = now - t0;
    const prog = Math.min(1, elapsed / 45000);
    barEl.style.transform = `scaleX(${1-prog})`;

    // speed
    const speed = SPEED_X + Math.floor((now - t0) / ACCEL_EACH_MS) * SPEED_STEP;

    if (started){
      birdVY += GRAVITY * (dt/1000);
      birdY  += birdVY * (dt/1000);

      const ang = clamp((birdVY/600)*45, ROT_UP, ROT_DOWN);
      birdEl.style.transform = `translate(-50%,-50%) rotate(${ang}deg)`;

      const topLimit = 0 + 6;
      const botLimit = h - SAFE_FLOOR_PAD;
      if (birdY <= topLimit){ birdY = topLimit; birdVY = 0; }
      if (birdY >= botLimit){ birdY = botLimit; if (!shieldActive){ crash(); return; } else { /* мягко отталкиваемся */ birdVY = -200; } }
    } else {
      birdY += Math.sin(now/300) * 0.12;
    }

// move pipes/items (+ coin magnet when shieldActive)
const dx = speed * dt/1000;
for (const p of pipes){ 
  p.x -= dx; 
  positionPipe(p); 
}

for (const it of items){
  // обычный скролл сцены
  it.x -= dx;

  // магнит только для монет и только при активном щите
  if (MAGNET_ENABLED && shieldActive && it.type === 'coin'){
    const vx = birdX - it.x;
    const vy = birdY - it.y;
    const dist = Math.hypot(vx, vy);

    if (dist < MAGNET_RADIUS){
      // шаг притяжения (ограничиваем, чтобы не «перескакивало»)
      const pull = MAGNET_PULL_PX_S * (dt/1000);
      const step = Math.min(pull, dist || 0);
      const nx = vx / (dist || 1);
      const ny = vy / (dist || 1);

      it.x += nx * step;
      it.y += ny * step;

      // лёгкий визуальный намёк: чуть увеличим монетку, когда в зоне магнита
      it.el.style.transform = 'translate(-50%,-50%) scale(1.08)';
    } else {
      it.el.style.transform = 'translate(-50%,-50%)';
    }
  } else {
    // вне магнита — обычный размер
    it.el.style.transform = 'translate(-50%,-50%)';
  }

  positionItem(it);
}


    // passed score
    for (const p of pipes){
      if (!p.passed && p.x + (ASSETS.pipes.width||76) < birdX){
        p.passed = true; score += 1; setScore(score); haptic('light');
      }
    }

    // remove off-screen
    while (pipes.length && pipes[0].x < -(ASSETS.pipes.width||76)-2){ removePipe(pipes[0]); pipes.shift(); }
    while (items.length && items[0].x < -80){ removeItem(items[0]); items.shift(); }

    // collisions
    collideItems();
    if (started && collidePipe()){
      if (shieldActive){
        // гасим щит при касании трубы и даём микро-отдачу
        shieldActive = false; birdEl.classList.remove('fl-bird--shield'); shBar.style.transform = 'scaleX(0)';
        birdVY = -260;
      } else {
        crash(); return;
      }
    }

    // spawn pipes
    if (now - spawnT > PIPE_SPAWN_MS){ spawnT = now; spawnPipe(); }

    // HUD
    applyBird();
    updateShieldHud();

    raf = requestAnimationFrame(tick);
  }

  function crash(){ haptic('heavy'); finish(); }
  function finish(){
    running=false; cancelAnimationFrame(raf);
    if (score > best){ best=score; try{ localStorage.setItem('flappy_best', String(best)); }catch(_){ } }
    document.getElementById('fl-best').textContent = best;
    document.getElementById('fl-world').textContent = WORLD_RECORD;
    resBox.classList.add('show'); cta.classList.add('show');
  }

  function resetScene(){
    // clear
    pipes.forEach(removePipe); pipes = [];
    items.forEach(removeItem); items = [];
    coins=0; setCoins(0);
    shieldActive=false; birdEl.classList.remove('fl-bird--shield'); shBar.style.transform = 'scaleX(0)';
    // bird
    started=false; score=0; setScore(0);
    hintEl.style.display = '';
    birdVY = 0; birdEl.style.transform = 'translate(-50%,-50%) rotate(0deg)';
    layout();
    // spawn timer
    spawnT = performance.now() + 400;
    tick._prev = performance.now();
  }

  function openFlappy(){
    root.classList.add('is-open'); document.body.classList.add('flappy-open');
    try{
      TG?.BackButton?.show?.();
      backOff = ()=> closeFlappy();
      TG?.BackButton?.onClick?.(backOff);
      TG?.disableVerticalSwipes?.(); TG?.expand?.();
    }catch(_){}

    resBox.classList.remove('show'); cta.classList.remove('show');

    applyAssets();
    layout(); resetScene();

    running = true; t0 = performance.now(); raf = requestAnimationFrame(tick);
  }

  function closeFlappy(){
    running=false; cancelAnimationFrame(raf);
    root.classList.remove('is-open'); document.body.classList.remove('flappy-open');
    try{ TG?.BackButton?.offClick?.(backOff); TG?.BackButton?.hide?.(); }catch(_){}
  }

  // controls
  stage.addEventListener('pointerdown', (e)=>{ e.preventDefault(); flap(); }, {passive:false});
  document.addEventListener('keydown', (e)=>{
    if (!root.classList.contains('is-open')) return;
    if (e.code==='Space' || e.key==='ArrowUp'){ e.preventDefault(); flap(); }
    if (e.key==='Escape'){ closeFlappy(); }
  });

  // CTA
  cta.addEventListener('click', (e)=>{
    if (!e.target.closest('.btn')) return;
    closeFlappy(); openFlappy();
  });

  // openers
  document.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-open-flappy]'); if (!t) return;
    e.preventDefault(); openFlappy();
  });
  document.addEventListener('click', (e)=>{
    if (e.target.closest('[data-close-flappy]')) closeFlappy();
  });

  // resize
  const ro = new ResizeObserver(()=> layout());
  ro.observe(stage);
})();
</script>











<script>
(function () {
  const wheel = document.getElementById('bonusWheel');
  const track = document.getElementById('wheelTrack');
  if (!wheel || !track) return;

  const items = Array.from(track.children);
  const N = items.length;

  const pill  = document.getElementById('pickedPill');
  const claim = document.getElementById('claimBtn');
  const spin  = document.getElementById('spinBtn');

  /* Название -> ссылка (поменяй под себя) */
  const bonusLinks = {
    "Кружка": "#profile",
    "Футболка": "#profile",
    "Фисташки": "#profile",
    "Скидка": "#profile",
    "Дегустация": "#profile",
    "Монеты": "#profile"
  };

  /* ================== общие утилиты ================== */
  let STEP = 114; // уточняем по факту после рендера
  requestAnimationFrame(() => {
    const a = items[0]?.getBoundingClientRect();
    const b = items[1]?.getBoundingClientRect();
    if (a && b) {
      const dx = Math.round(b.left - a.left);
      if (dx > 40 && dx < 300) STEP = dx;
    }
  });

  let curr = 0; // «плавающее» положение
  let startX = 0, startCurr = 0, dragging = false, lastX = 0, lastT = 0, vel = 0;
  let interacted = false; // станет true после первого выбора
  let spinning = false;   // блок повторного старта

  const mod = (a, n) => ((a % n) + n) % n;
  const easeOut = t => 1 - Math.pow(1 - t, 3);
  function nearest(curr, idx, n) {
    let t = idx;
    while (t - curr > n / 2) t -= n;
    while (curr - t > n / 2) t += n;
    return t;
  }

  /* ===== Хаптики (Telegram + фоллбек) ===== */
  const TG = window.Telegram && window.Telegram.WebApp;
  function hapticPulse(level = 'light') {
    try {
      if (TG?.HapticFeedback) {
        if (level === 'selection') return TG.HapticFeedback.selectionChanged();
        TG.HapticFeedback.impactOccurred(level); // 'soft' | 'light' | 'medium' | 'heavy' | 'rigid'
        return;
      }
    } catch (_) {}
    try { if (navigator.vibrate) { navigator.vibrate(level === 'heavy' ? 30 : level === 'medium' ? 20 : 12); } } catch (_) {}
  }

  /* ====== Кулдаун «Забрать бонус» + таймер ====== */
  const COOLDOWN_MS = 0.1 * 60 * 60 * 1000; // 24 часа
  const UID = (TG?.initDataUnsafe?.user?.id) || 'anon';
  const CLAIM_KEY = 'bonusClaim_ts_' + UID;

  function getLastClaim() { return +(localStorage.getItem(CLAIM_KEY) || 0); }
  function setLastClaim(ts = Date.now()) { localStorage.setItem(CLAIM_KEY, String(ts)); }
  function remainingMs() { return Math.max(0, getLastClaim() + COOLDOWN_MS - Date.now()); }
  function fmtClock(ms) {
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(ss).padStart(2, '0');
  }

  let claimTimerId = null;
  function refreshClaimState() {
    if (!claim) return;

    const rem = remainingMs();
    const canClaim = interacted && rem <= 0;

    if (canClaim) {
      claim.disabled = false;
      claim.textContent = 'Забрать бонус';
      if (claimTimerId) { clearInterval(claimTimerId); claimTimerId = null; }
    } else {
      claim.disabled = true;
      if (interacted && rem > 0) {
        claim.textContent = 'Доступно через ' + fmtClock(rem);
        if (!claimTimerId) {
          claimTimerId = setInterval(() => {
            const r = remainingMs();
            if (r > 0) claim.textContent = 'Доступно через ' + fmtClock(r);
            else {
              clearInterval(claimTimerId); claimTimerId = null;
              claim.textContent = 'Забрать бонус';
              claim.disabled = !interacted;
            }
          }, 1000);
        }
      } else {
        claim.textContent = 'Забрать бонус';
        if (claimTimerId) { clearInterval(claimTimerId); claimTimerId = null; }
      }
    }
  }

  /* ================== UI ================== */
  function updatePillByIndex(idx) {
    const it = items[idx];
    const name = it?.dataset?.name || '—';
    const img = it?.querySelector('img')?.src || '';
    if (!pill) return;
    pill.classList.remove('muted');
    pill.innerHTML = img ? `<img src="${img}" alt=""><span>${name}</span>` : name;
    if (claim) {
      claim.disabled = false;
      claim.dataset.bonus = name;
    }
  }

  function updateUI() {
    // позиционирование как «кольцо»
    items.forEach((el, i) => {
      let dx = i - curr;
      dx = mod(dx + N / 2, N) - N / 2; // (-N/2; N/2]
      const x = dx * STEP;
      const s = 1 - Math.min(Math.abs(dx) * 0.16, 0.48);
      el.style.transform = `translate(-50%,-50%) translateX(${x}px) scale(${s})`;
      el.style.zIndex = String(1000 - Math.abs(dx) * 10);
      el.classList.toggle('active', Math.round(Math.abs(dx)) === 0);
    });

    if (interacted) {
      updatePillByIndex(mod(Math.round(curr), N));
    } else {
      if (pill) { pill.classList.add('muted'); pill.textContent = 'Нажми «Крутануть»'; }
      if (claim) { claim.disabled = true; delete claim.dataset.bonus; }
    }

    // важное: синхронизация состояния кнопки с кулдауном и монетами
    refreshClaimState();
    syncCoinsUI();
  }

  /* ====== Вращение со слабой вибрацией ====== */
  function spinTo(targetIdx, laps = 1, dur = 1600) {
    const base = nearest(curr, targetIdx, N);
    const dir = (base >= curr ? 1 : -1) || 1;
    const to = base + dir * (laps * N);

    const from = curr, t0 = performance.now();
    let lastPulse = 0;

    function tick(t) {
      const k = Math.min((t - t0) / dur, 1);
      curr = from + (to - from) * (1 - Math.pow(1 - k, 3)); // easeOut
      updateUI();

      // лёгкие пульсы во время вращения (в начале чаще)
      const period = 80 + 180 * k; // 80ms → 260ms
      if (t - lastPulse >= period) { hapticPulse('light'); lastPulse = t; }

      if (k < 1) {
        requestAnimationFrame(tick);
      } else {
        curr = to;
        interacted = true;
        updateUI();
      }
    }
    requestAnimationFrame(tick);
  }

  function snapTo(targetIdx, dur = 420) {
    const to = nearest(curr, targetIdx, N);
    const from = curr;
    const t0 = performance.now();
    function tick(t) {
      const k = Math.min((t - t0) / dur, 1);
      curr = from + (to - from) * easeOut(k);
      updateUI();
      if (k < 1) requestAnimationFrame(tick);
      else { curr = to; interacted = true; updateUI(); }
    }
    requestAnimationFrame(tick);
  }

  /* ================== Кошелёк монет ================== */
  const COIN_KEY = 'beer_coins';
  const SPIN_COST = 1;

  function getCoins(){ return +(localStorage.getItem(COIN_KEY) || 0); }
  function setCoins(v){
    v = Math.max(0, v|0);
    localStorage.setItem(COIN_KEY, String(v));
    syncCoinsUI();
  }
  function addCoins(n){ setCoins(getCoins() + (n|0)); }

  function syncCoinsUI(){
    ['coins-inline','coins-inline-2','coins-profile'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.textContent = getCoins();
    });
    if (spin){
      const lock = (getCoins() < SPIN_COST) || spinning;
      spin.classList.toggle('is-locked', lock);
      // Не делаем spin.disabled — чтобы клик показывал тост
    }
  }

  // (опционально) стартовый баланс для теста:
  if (getCoins() === 0) addCoins(300);

  /* ================== Toasts (всплывашки) ================== */
  function ensureToastStyles(){
    if (document.getElementById('toast-styles')) return;
    const css = `
.toasts{
  position:fixed; right:16px; bottom:calc(env(safe-area-inset-bottom,0px) + 16px);
  z-index:100000; display:grid; gap:8px; width:min(92vw,320px); pointer-events:none;
}
.toast{
  pointer-events:auto; display:flex; align-items:center; gap:10px;
  padding:12px 14px; border-radius:14px; color:#fff;
  background:rgba(18,20,24,.96); border:1px solid rgba(255,255,255,.12);
  box-shadow:0 10px 24px rgba(0,0,0,.35);
  transform:translateX(120%); opacity:0; animation:toast-in .25s ease forwards;
}
.toast--error{ border-color:rgba(255,107,107,.45); box-shadow:0 10px 24px rgba(255,107,107,.15); }
.toast--ok{    border-color:rgba(55,214,122,.45);  box-shadow:0 10px 24px rgba(55,214,122,.15); }
.toast__close{ margin-left:auto; opacity:.7; background:transparent; border:0; color:inherit; cursor:pointer; }
@keyframes toast-in { to { transform:translateX(0); opacity:1; } }
@keyframes toast-out{ to { transform:translateX(120%); opacity:0; } }

/* визуально «блок»: */
#spinBtn.is-locked{ opacity:.6; }
#spinBtn.is-locked:active{ transform:none; }

/* простые конфетти */
#confetti { position: fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:visible; z-index:10000; }
.confetti-piece{ position: fixed; left: var(--x); top: var(--y); width:8px; height:8px; border-radius:2px; transform: translate(-50%,-50%); animation: confetti-fall .95s ease-out forwards; }
@keyframes confetti-fall { to { transform: translate(calc(var(--dx)), calc(var(--dy))) rotate(260deg); opacity:0; } }
`;
    const style = document.createElement('style');
    style.id = 'toast-styles';
    style.textContent = css;
    document.head.appendChild(style);
  }

  function showToast(msg, type='error', ms=3000){
    ensureToastStyles();
    const host = document.getElementById('toasts') || (()=>{
      const d=document.createElement('div'); d.id='toasts'; d.className='toasts';
      document.body.appendChild(d); return d;
    })();
    const el = document.createElement('div');
    el.className = 'toast' + (type==='ok' ? ' toast--ok' : ' toast--error');
    el.innerHTML = `<span>${msg}</span><button class="toast__close" aria-label="Закрыть">✕</button>`;
    host.appendChild(el);
    const close = ()=>{ el.style.animation='toast-out .22s ease forwards'; setTimeout(()=> el.remove(), 240); };
    el.querySelector('.toast__close').addEventListener('click', close);
    setTimeout(close, ms);
  }

  /* ================== события ================== */
  // клик по карточке — центрируем её
  /*
  track.addEventListener('click', (e) => {
    const b = e.target.closest('.bonus'); if (!b) return;
    const idx = items.indexOf(b);
    if (idx >= 0) snapTo(idx, 320);
  });

  // свайп / drag
  track.addEventListener('pointerdown', (e) => {
    dragging = true; wheel.classList.add('dragging');
    startX = lastX = e.clientX; lastT = e.timeStamp; startCurr = curr;
    track.setPointerCapture(e.pointerId);
  });
  track.addEventListener('pointermove', (e) => {
    if (!dragging) return;
    const dx = e.clientX - startX;
    curr = startCurr - dx / STEP;               // бесконечная карусель
    const dt = e.timeStamp - lastT;
    if (dt > 0) { vel = (e.clientX - lastX) / dt; lastX = e.clientX; lastT = e.timeStamp; }
    updateUI();
  }, { passive: true });
  function endDrag() {
    if (!dragging) return;
    dragging = false; wheel.classList.remove('dragging');
    interacted = true;
    snapTo(mod(Math.round(curr - vel * 6), N), 480);
  }
  track.addEventListener('pointerup', endDrag);
  track.addEventListener('pointercancel', endDrag);
  */

  /* ===== Крутануть с оплатой монет + тост при нехватке ===== */
  spin?.addEventListener('click', () => {
    if (spinning) return;

    if (getCoins() < SPIN_COST) {
      hapticPulse('medium');
      showToast(`Недостаточно монет. Нужно ${SPIN_COST} 🪙`, 'error', 3000);
      return;
    }

    // списываем монеты перед стартом
    setCoins(getCoins() - SPIN_COST);
    hapticPulse('light');

    // запускаем вращение
    spinning = true;
    const idx = Math.floor(Math.random() * N);
    spinTo(idx, 1, 1600);

    // конфетти из кнопки
    const r = spin.getBoundingClientRect();
    confettiBurst(r.left + r.width / 2, r.top + r.height / 2);

    // разблокируем по окончании анимации
    setTimeout(() => {
      spinning = false;
      syncCoinsUI();
    }, 1650);
  });

  /* ===== «Забрать бонус» — учёт кулдауна + запись в профиль + переход ===== */
  claim?.addEventListener('click', () => {
    if (claim.disabled) return; // на всякий

    const idx = mod(Math.round(curr), N);
    const name = items[idx]?.dataset?.name || '';
    const url = bonusLinks[name];

    // фиксируем время клика и обновляем кнопку/таймер
    setLastClaim();
    refreshClaimState();

    // обновляем профиль (если есть глобальный объект)
    try {
      window.Profile?.incPoints?.(100);   // +100 очков (пример)
      window.Profile?.setPrize?.(name);   // последний приз
    } catch (_) {}

    // переход по ссылке приза
    if (!url) return;
    if (url.startsWith('#')) location.hash = url;
    else if (/^https?:\/\//.test(url)) window.open(url, '_blank');
    else window.location.href = url;
  });

  /* ================== конфетти (DOM) ================== */
  function confettiBurst(x, y) {
    ensureToastStyles(); // тут также лежит CSS для конфетти
    let layer = document.getElementById('confetti');
    if (!layer) { layer = document.createElement('div'); layer.id = 'confetti'; document.body.appendChild(layer); }
    const colors = ['#7b5bff', '#3de0c5', '#ffd166', '#ef476f', '#06d6a0', '#118ab2'];
    const rect = document.body.getBoundingClientRect();
    const ox = (x ?? rect.width / 2), oy = (y ?? rect.height / 3);
    for (let i = 0; i < 36; i++) {
      const el = document.createElement('div');
      el.className = 'confetti-piece';
      el.style.background = colors[i % colors.length];
      const angle = (i / 36) * Math.PI * 2;
      const speed = 140 + Math.random() * 120;
      const dx = Math.cos(angle) * speed, dy = Math.sin(angle) * speed + 220;
      el.style.setProperty('--x', ox + 'px');
      el.style.setProperty('--y', oy + 'px');
      el.style.setProperty('--dx', dx + 'px');
      el.style.setProperty('--dy', dy + 'px');
      layer.appendChild(el);
      setTimeout(() => el.remove(), 950);
    }
  }

  /* старт */
  updateUI();          // отрисовать колесо + плашку
  refreshClaimState(); // сразу проверить кулдаун на кнопке
  syncCoinsUI();       // и с монетами
})();
</script>


</body>
</html>
